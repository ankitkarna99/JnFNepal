!function(a,b,c,d){"use strict";c.module("esewaPaymentApp",["restangular","ngStorage","esewaMessages","esewaSharedApp","ui.router"]).run(["$rootScope","$state","$localStorage","$http","$timeout","$sce","$location","$templateCache",function(a,b,c,d,e,f,g,h){}]),c.module("esewaPaymentApp").controller("AirlinePdfAndNotificationController",["$http","$scope","FileSaverFactory","$modal","$rootScope","$timeout","$window","ecmsg",function(a,b,d,e,f,g,h,i){new Date;f.$on("GetPdf",function(){g(function(){b.getPdf(f.ticketDetails.transaction_code)},100)}),b.sendNotification=function(a,c,d,e){b.openSendNotificationDialog(a,c,d,e)},b.openSendNotificationDialog=function(a,b,c,d){e.open({templateUrl:"/user/merchant/airlines/views/send_notification_panel.html",controller:j,size:"sm",backdrop:"static",resolve:{notificationId:function(){return b},type:function(){return a},txnCode:function(){return c},buyerName:function(){return d}}})};var j=["$scope","$rootScope","$modalInstance","notificationId","type","AirlinesService","txnCode","ValidationService","ecmsg","buyerName",function(a,b,d,e,f,g,h,i,j,k){a.notificationId=e,a.type=f,a.txnCode=h,a.buyerName=k,a.cancel=function(){d.dismiss()},b.currentModal=d,a.sendNotification=function(e,f,h,k){if("SMS"===e){if(!i.checkMobileValid(f))return!1;a.notificationSmsDto={mobile_number:f,txn_code:h,buyer_name:k},g.sendNotificationToSms(a.notificationSmsDto).then(function(b){a.notificationResponse=b,j.success("SMS proceeded","")},function(d){a.showModificationPanel=!1,b.showInformation=!1,c.isDefined(d)&&(d.data.error_message?b.message.error=d.data.error_message:b.message.error="Unable to fetch user profile.")})}else{if(!i.checkEmailValid(f))return!1;a.notificationEmailDto={email_id:f,txn_code:h,buyer_name:k},g.sendNotificationToEmail(a.notificationEmailDto).then(function(b){a.notificationResponse=b,j.success("Email proceeded","")},function(d){a.showModificationPanel=!1,b.showInformation=!1,c.isDefined(d)&&(d.data.error_message?b.message.error=d.data.error_message:b.message.error="Unable to fetch user profile.")})}d.dismiss()}}];b.showTicketSendOption=function(a){a=a.replace(/(\d{2})-(\d{2})-(\d{4})/,"$2/$1/$3");var b=new Date(a);return new Date<=b}}]),c.module("esewaPaymentApp").controller("AirlineServiceController",["$scope","$rootScope","$modalInstance","airlines",function(a,b,c,d){a.airlinesServices=d,b.currentModal=c,a.cancel=function(){c.dismiss()},b.currentModal=c}]),c.module("esewaPaymentApp").controller("AirLinesController",["$scope","$rootScope","$state","AirlinesService","DateFormatter","$timeout","StateConstant","AirlineCalculator","$modal","$location","$window","$http","FileSaverFactory","AirlinePassengerDetailService","StatementService","ecmsg","PropertyConstant",function(a,b,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){function s(){this.departureDate=new Date,this.arrivalDate=new Date}function t(b){a.arrivalResource=b}function u(b){a.filterAirlines=[{code:b.airline_code}],a.searchedAirlinesArrival=i.getFilteredDate(a.filterAirlines,a.searchedAirlinesArrival,b),a.departureResource=b}function v(){a.showReturnFlightList=!0,a.showDepartureFlightList=!1}function w(){a.showDepartureFlightList=!1,a.showReturnFlightList=!1}function x(){l.scrollTo({top:0,behavior:"smooth"})}b.clearMessage(),a.nationality=["Nepalese","Indian"],a.tripTypes=[{key:"O",value:"One Way"},{key:"R",value:"Two Way"}],a.selectedAirlineList=[],a.outboundFlightId="",a.inboundFlightId="",a.pnrResponse="",b.message={},a.CheckDate=function(){a.searchRequest.dateRange.arrivalDate<a.searchRequest.dateRange.departureDate&&(a.searchRequest.dateRange.arrivalDate=a.searchRequest.dateRange.departureDate)},a.goToState=function(a){"airlines"===a&&d.go("merchant.airlines.search")},a.initAirlinesDetialListPage=function(){a.searchRequest.origin.name||b.goToState(h.AIRLINES_SEARCH)};var y=new Date;a.title=["Mr","Ms","Mrs"],a.airlineMaps=[],a.airlineMapsCopy=[],a.showSameMessage=!1,a.showloadingBar=!1,a.datePicker={startDate:y},a.searchRequest={selectedAirlineList:[{code:""}],origin:{id:"",name:""},destination:{id:"",name:""},arrivalDate:"",departureDate:"",dateRange:new s,tripType:{key:"O",value:"One Way"},noOfAdult:1,noOfChild:0,noOfInfant:""},d.current.name===h.AIRLINES_TICKET&&p.getTxnDetails(d.params.txnId,d.params.moduleId).then(function(b){a.ticketDetails=b.plain(),a.setAirTicket(a.ticketDetails)},function(a){c.isDefined(a)?b.message.error=a.data.error_message:b.message.error="Error while fetching data."}),a.getSectors=function(){a.sectors||e.getSector().then(function(b){a.sectors=[],c.isDefined(b.plain)&&_.forEach(b.plain(),function(b,c){a.sectors.push({id:c,name:b})}),a.sectors=_.sortBy(a.sectors,"name")},function(a){b.showInformation=!1,c.isDefined(a)&&(a.data.error_message?b.message.error=a.data.error_message:b.message.error="Service is currently unavailable. please, try again later.")})},a.getAirlinesList=function(){0===a.airlineMaps.length&&e.getAirlines().then(function(b){a.airlines=b.plain(),c.isDefined(b.plain())&&(_.forEach(a.airlines,function(b,c){a.airlineMaps.push({code:b.code,icon:b.logo,name:b.name,maker:c})}),a.airlineMapsCopy=c.copy(a.airlineMaps))},function(a){b.showInformation=!1,c.isDefined(a)&&(a.data.error_message?b.message.error=a.data.error_message:b.message.error="Service is currently unavailable. please, try again later.")})},a.checkTripType=function(b){"R"===b&&(a.searchRequest.dateRange.arrivalDate=a.searchRequest.dateRange.departureDate)},a.checkSame=function(a,b){return!(!c.isDefined(a)||!c.isDefined(b)||""===a&&""===b)&&a.id===b.id},g(function(){a.getSectors(),a.getAirlinesList()},100),a.getAirlinesAvailability=function(){e.getAirlinesAvailabilities(a.searchAirDto).then(function(e){a.availableAirlines=e.plain(),a.showReturnFlightList=!1,a.showDepartureFlightList=!0,a.showloadingBar=!1,a.searchedAirlines=a.availableAirlines.outbound_flight_details,a.searchedAirlinesForFilter=a.availableAirlines.outbound_flight_details,a.priceArray=[];for(var f=0;f<a.searchedAirlines.length;f++)a.priceArray.push(a.searchedAirlines[f].total_amount);return a.minAirlineSearchedPrice=Math.min.apply(null,a.priceArray),a.maxAirlineSearchedPrice=Math.max.apply(null,a.priceArray),c.isDefined(a.availableAirlines.inbound_flight_details)&&c.isDefined(a.availableAirlines.outbound_flight_details)&&!a.availableAirlines.inbound_flight_details&&!a.availableAirlines.outbound_flight_details?(b.showInformation=!1,b.successResponse.message=!1,void(b.message.error="No flight available on this searched criteria. Please, select other options")):(a.searchedAirlines.tripType="O",a.searchedAirlinesArrival=a.availableAirlines.inbound_flight_details,a.searchedAirlinesArrival&&(a.searchedAirlinesArrival.tripType="R"),void(null!==a.searchedAirlines||a.searchedAirlines&&0!==a.searchedAirlines.length?(a.totalFlightCount=a.searchedAirlines.length,d.go(h.AIRLINES_LIST)):(b.showInformation=!1,b.message.error="No flight available on this searched criteria. Please, select other options")))},function(d){a.showloadingBar=!1,a.showMessage="No data available",b.showInformation=!1,c.isDefined(d)&&(d.data.error_message?b.message.error=d.data.error_message:b.message.error="Flights are not available with provided search parameters.")})},a.findFlightsFromServer=function(){if(!((a.searchRequest.noOfAdult>0||a.searchRequest.noOfAdult>0)&&a.searchRequest.destination&&a.searchRequest.origin&&a.searchRequest.dateRange.departureDate))return a.showloadingBar=!1,!1;if(!(a.searchRequest.noOfAdult>-1&&a.searchRequest.noOfAdult>-1))return a.showloadingBar=!1,!1;if(a.searchRequest.destination===a.searchRequest.origin)return a.showloadingBar=!1,!1;if(a.searchRequest.dateRange.departureDate>a.searchRequest.dateRange.arrivalDate&&"R"===a.searchRequest.tripType.key)a.showErrorMessage="Please select correct departure and arrival date.";else{var c=0;for(var d in a.searchRequest.selectedAirlineList)a.searchRequest.selectedAirlineList.hasOwnProperty(d)&&c++;a.searchAirDto={airline_code:1===c?a.searchRequest.selectedAirlineList[0].code:"",flight_date:f.formatDate(a.searchRequest.dateRange.departureDate),return_date:f.formatDate(a.searchRequest.dateRange.arrivalDate),origin:a.searchRequest.origin.id,destination:a.searchRequest.destination.id,no_of_adult:"Select"===a.searchRequest.noOfAdult?0:a.searchRequest.noOfAdult,no_of_child:"Select"===a.searchRequest.noOfChild?0:a.searchRequest.noOfChild,trip_type:a.searchRequest.tripType},a.flightDetailTripType=a.searchRequest.tripType.value,a.selectedTripTypeId=a.searchRequest.tripType,a.searchedAirlines=[],a.searchedAirlinesArrival=[],b.isLoggedIn()&&(""!==a.searchAirDto.destination&&a.searchAirDto.origin?a.getAirlinesAvailability():a.showloadingBar=!1)}},a.findFlights=function(){b.clearMessage(),a.resetLeftPanel(),a.showloadingBar=!0,b.isAuthenticated()||(a.showloadingBar=!1,b.openLoginDialog(k.absUrl())),a.findFlightsFromServer(),a.showModificationPanel=!1},a.formattedDate=f,a.slider_visible_bar={value:1e4,options:{showSelectionBar:!0}},a.minSlider={value:10},a.filterAirlines=[],a.reverseSort=!1,a.getAirlinesFlightPrice=function(b){a.priceFilteredAirlines=[],a.priceFilteredAirlines=b,a.searchedAirlines=i.getFilteredAirlinesByPrice(a.priceFilteredAirlines,a.searchedAirlines)},a.getAirlinesFlightArrival=function(b){a.arrivalFilteredAirlines=[],a.arrivalFilteredAirlines=b},a.filterAirlines=[],a.initialIsChecked=!1,a.getFilteredDate=function(b,c){c===!0?(a.filterAirlines.push(b),a.searchedAirlines=i.getFilteredDate(a.filterAirlines,a.availableAirlines.outbound_flight_details,null)):(a.filterAirlines.splice(a.filterAirlines.indexOf(b),1),0===a.filterAirlines.length?a.getAllAirlinesNotSelected():a.searchedAirlines=i.getFilteredDate(a.filterAirlines,a.availableAirlines.outbound_flight_details,null)),a.totalFlightCount=a.searchedAirlines.length},a.searchByPrice=function(b){a.searchedAirlines=i.getFilteredDateByPrice(b,a.availableAirlines.outbound_flight_details,null),a.totalFlightCount=a.searchedAirlines.length},a.disabledFlights=!1,a.getAllAirlines=function(){a.disabledFlights=!a.disabledFlights,a.selectedAirlines=[],a.searchedAirlines=a.availableAirlines.outbound_flight_details},a.getAllAirlinesNotSelected=function(){a.selectedAirlines=[],a.searchedAirlines=a.availableAirlines.outbound_flight_details},a.showDetails=function(b){a.flightID=b;var c=0,d=a.searchedAirlines.length;for(c;c<d;c++)a.searchedAirlines[c].flight_id===b&&(a.individualFlightDetail=a.searchedAirlines[c],a.totalPassenger=1*a.individualFlightDetail.no_of_adult+1*a.individualFlightDetail.no_of_child+1*a.individualFlightDetail.no_of_infant,a.totalPayingAmount=i.getTotalPayingAmount(a.individualFlightDetail.total_amount,a.individualFlightDetail.cashback));a.openFlightDetailDialog(a.individualFlightDetail,a.totalPassenger,a.totalPayingAmount)},a.openFlightDetailDialog=function(a,b,c){j.open({templateUrl:"/user/merchant/airlines/views/flight_detail_panel.html",controller:"FlightDetailsController",size:"lg",backdrop:"static",resolve:{individualFlightDetail:function(){return a},totalPassenger:function(){return b},totalPayingAmount:function(){return c}}})},a.modifySearch=function(){a.showModificationPanel=!a.showModificationPanel},a.checkTripType=function(b){"R"===b&&(a.searchRequest.arrivalDate=a.searchRequest.departureDate)},a.cancelModifySearch=function(){a.showModificationPanel=!1,a.findFlightsFromServer()},a.showFilters=!0,a.selectFlightForBooking=function(b,c){a.openReloadPageDialog(b,c)},a.resetLeftPanel=function(){a.departureResource="",a.arrivalResource="",a.showReturnFlightList=!1},a.openReloadPageDialog=function(b,c){j.open({templateUrl:"/user/merchant/airlines/views/airline_reload.html",controller:"AirLineReloadController",size:"md",backdrop:"static",resolve:{airLine:function(){return b},tripType:function(){return c},confirmFlight:function(){return a.confirmFlight}}})},a.confirmFlight=function(c,d){b.showFilters=!1,"R"===c?(a.inboundFlightId=d.flight_id,u(d),v()):(a.OutboundFlightId=d.flight_id,t(d),w())},a.bookOneWayFlight=function(b){a.outboundFlightId=b.flight_id,a.calculatePassengers(a.searchRequest),a.departureResource=b,a.totalPayingAmount=i.getTotalPayingAmount(a.departureResource.total_amount,a.departureResource.cashback),a.totalPassenger=1*b.no_of_adult+1*b.no_of_child+1*b.no_of_infant,a.reserveFlight(a.departureResource.flight_id,"",a.selectedTripTypeId,a.totalPayingAmount)},a.bookRoundTripFLights=function(b,c){a.calculatePassengers(a.searchRequest),a.departureResource=b,a.arrivalResource=c,a.totalPayingAmount=i.getTotalPayingAmount(a.departureResource.total_amount,a.departureResource.cashback),a.totalPayableAmountRoundWay=i.getTotalPayingAmount(a.arrivalResource.total_amount,a.arrivalResource.cashback),a.totalPassenger=1*b.no_of_adult+1*b.no_of_child+1*b.no_of_infant,a.totalRoundTripAmount=1*a.totalPayingAmount+1*a.totalPayableAmountRoundWay,a.reserveFlight(a.departureResource.flight_id,a.arrivalResource.flight_id,a.selectedTripTypeId,a.totalPayableAmountRoundWay)},a.reserveFlight=function(f,g,i,j){a.airlineReservationDto={flight_id:f,return_flight_id:g,trip_type:i.key},a.showloadingBar=!0,e.reserveFlight(a.airlineReservationDto).then(function(b){if(a.showloadingBar=!1,c.isDefined(b)){a.pnrResponse=b.plain();var e={};_.forEach(a.pnrResponse,function(b,c){e=a.pnrResponse[c]}),_.forEach(e,function(b,c){var d=e[c];d.flight_id===a.airlineReservationDto.flight_id?a.departureResource.pnrNo=d.pnr_no:d.flight_id===a.airlineReservationDto.return_flight_id&&(a.arrivalResource.pnrNo=d.pnr_no)}),a.checkBalance(j),d.go(h.AIRLINES_PASSANGER),x()}},function(c){b.showInformation=!1,a.showloadingBar=!1,c.data.error_message?q.error(c.data.error_message,""):""!==c.data.message&&c.data.message?q.error(c.data.message,""):q.error("Service is currently unavailable. please, try again later."),d.go("merchant.airlines.search")},function(){a.showloadingBar=!1,q.error("Service is currently unavailable. please, try again later.",""),d.go("merchant.airlines.search")})},a.calculatePassengers=function(b){a.numberOfAdults=[],a.numberOfChilds=[],a.numberOfInfants=[];var c;for(c=0;c<b.noOfAdult;c++)a.numberOfAdults.push(c);for(c=0;c<b.noOfChild;c++)a.numberOfChilds.push(c);for(c=0;c<b.noOfInfant;c++)a.numberOfInfants.push(c)},a.adultDtos=[],a.childDtos=[],a.infantDtos=[],a.getFirstName=function(b,d,e){c.isDefined(e)?a.adultDtos[b].firstName=d+" "+e:a.adultDtos[b].firstName=d},a.getFirstNameChild=function(b,d,e){c.isDefined(e)?a.childDtos[b].firstName=d+" "+e:a.childDtos[b].firstName=d},a.submitPassengerForm=function(d){a.adultDetails=i.getPassengerList(a.adultDtos,"ADULT"),a.childDetails=i.getPassengerList(a.childDtos,"CHILD"),a.infantDetails=i.getPassengerList(a.infantDtos,"INFANT"),a.passengerDetails=a.adultDetails.concat(a.childDetails,a.infantDetails),c.isDefined(a.arrivalResource)&&null!==a.arrivalResource?(a.returenFlightId=a.arrivalResource.flight_id,a.returnFlightDetail=a.arrivalResource,a.returnFlighTotalPaybleAmount=a.totalPayableAmountRoundWay):(a.returenFlightId="",a.returnFlightDetail="",a.returnFlighTotalPaybleAmount=""),a.airlineTicketIssueDto={flight_id:a.departureResource.flight_id,return_flight_id:a.returenFlightId,contact_name:d.name,contact_email:d.email,contact_mobile:d.phoneNumber,passengers:a.passengerDetails,inbound_pnr_no:a.returnFlightDetail.pnrNo,outbound_pnr_no:a.departureResource.pnrNo,outboundChildCommission:a.departureResource.child_commission_amt,inboundChildCommission:a.returnFlightDetail.child_commission_amt,outboundAdultCommission:a.departureResource.agency_commission,inboundAdultCommission:a.returnFlightDetail.agency_commission},b.showloadingBar=!0,a.openConfirmFlightBookingDialog(a.airlineTicketIssueDto,a.departureResource,a.returnFlightDetail,a.returnFlighTotalPaybleAmount,a.totalPayingAmount,a.totalPassenger)},a.openConfirmFlightBookingDialog=function(b,c,d,e,f,g){j.open({templateUrl:"/user/merchant/airlines/views/continue_booking_confirmation.html",controller:"ConfirmContinueBookingController",size:"lg",resolve:{airlineTicketIssueDto:function(){return b},departureResource:function(){return c},returnFlightDetail:function(){return d},returnFlightTotalPayableAmount:function(){return e},totalPayableAmountOneWay:function(){return f},passengers:function(){return g},setAirTicket:function(){return a.setAirTicket}}})},a.setAirTicket=function(b){a.ticketDetails=b,a.mobileNumber=b.properties.buyerPhoneNumber,a.email=b.properties.buyerEmail,a.passengerDto=o.getAirlinePassengerDetail(b.properties)},a.getLeadPassengerInformation=function(d){d&&(a.showloadingBar=!0,e.getLeadPassengerDetail().then(function(b){g(function(){a.showloadingBar=!1},1e3),a.leadPassengerDetail=b.plain(),a.leadPassenger={name:a.leadPassengerDetail.name,email:a.leadPassengerDetail.email,phoneNumber:a.leadPassengerDetail.mobile_number,address:a.leadPassengerDetail.address};var c=a.leadPassenger.name;c&&(c=c.split(" "));var d=[];if(c){for(var e=0;e<c.length;e++)d.push(c[e]),e!==c.length-1&&d.push(" ");a.adultDtos[0].firstName=c[0],a.adultDtos[0].lastName=c[1].concat(" ",c[2]),a.adultDtos[0].nationality=a.nationality[0]}},function(d){a.showModificationPanel=!1,a.showloadingBar=!1,b.showInformation=!1,c.isDefined(d)&&(d.data.error_message?b.message.error=d.data.error_message:b.message.error="Unable to fetch user profile.")}))},a.checkBalance=function(d){a.showInsufficientBalance=!1,c.isDefined(d)&&c.isDefined(b.$storage.balance)&&d>b.$storage.balance.balance&&(a.showInsufficientBalance=!0)},a.getServiceDetail=function(b){a.openServiceDialogs(b)},a.openServiceDialogs=function(a){j.open({templateUrl:"/user/merchant/airlines/views/airline_service.html",controller:"AirlineServiceController",size:"sm",resolve:{airlines:function(){return a}}})},a.getRescheduleForm=function(){d.go(h.MAKE_PAYMENT,{product_code:r.AIRLINE_RESCHEDULE,product_name:"Airlines Date/Name Change"})},a.iconObj={},a.orderByField="",a.toogleSortIcon=function(b,c){a.orderByField=b,a.reverseSort=!a.reverseSort,a.iconObj={},a.iconObj[c]=!0},a.priceRangeFilter=function(b){a.priceFilteredFromSliderAirline=[];for(var c=0;c<a.searchedAirlinesForFilter.length;c++)a.searchedAirlinesForFilter[c].total_amount<=b&&a.priceFilteredFromSliderAirline.push(a.searchedAirlinesForFilter[c]);a.searchedAirlines=a.priceFilteredFromSliderAirline},a.resetPriceFilter=function(){a.filterAirlines.length?a.searchedAirlines=i.getFilteredDate(a.filterAirlines,a.availableAirlines.outbound_flight_details,null):a.searchedAirlines=a.searchedAirlinesForFilter,a.airlineMaps=c.copy(a.airlineMapsCopy)}}]),c.module("esewaPaymentApp").controller("AirLineReloadController",["$scope","$rootScope","$modalInstance","airLine","tripType","confirmFlight",function(a,b,c,d,e,f){a.information=d,a.tripType=e,a.cancel=function(){c.dismiss()},a.confirmFlight=function(){f(a.tripType,a.information),c.dismiss()},b.currentModal=c}]),c.module("esewaPaymentApp").controller("ConfirmContinueBookingController",["$scope","$rootScope","$modalInstance","airlineTicketIssueDto","departureResource","returnFlightDetail","AirlinesService","returnFlightTotalPayableAmount","totalPayableAmountOneWay","passengers","$timeout","ecmsg","$state","AirlinePassengerDetailService","StateConstant","setAirTicket",function(a,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){d.load=!0,a.departureFlightDetail=g,a.returnFlightDetail=h,a.airlineTicketIssueDto=f,a.passengers=l,a.totalPayableAmountOneWay=k,a.returnFlightTotalPayableAmount=j,c.isDefined(a.returnFlightTotalPayableAmount)?a.grandTotalAmount=1*a.totalPayableAmountOneWay+1*a.returnFlightTotalPayableAmount:a.grandTotalAmount=1*a.totalPayableAmountOneWay,d.currentModal=e,a.cancel=function(){d.load=!1,e.dismiss()},a.continueBooking=function(){d.load=!0;var g=d.$storage.profile.esewaId+"_"+b.performance&&b.performance.now&&b.performance.timing&&b.performance.timing.navigationStart?b.performance.now()+b.performance.timing.navigationStart:Date.now();f.unique_id=d.$storage.profile.esewaId+"_"+g,m(function(){i.makeFlightPayment(f).then(function(b){d.load=!1,a.ticketDetails=b.plain(),r(a.ticketDetails),e.dismiss(),d.$emit("GeneratePdf",a.ticketDetails.transaction_code),o.go(q.AIRLINES_TICKET,{txnId:a.ticketDetails.transaction_code,moduleId:a.ticketDetails.module_id}),m(function(){a.$emit("GetPdf",{txnId:a.ticketDetails.transaction_code,moduleId:a.ticketDetails.module_id})},500),d.clearMessage()},function(b){a.showInformation=!1,d.load=!1,c.isDefined(b)&&(b.data.error_message?n.error(b.data.error_message,""):""!==b.data.message&&b.data.message?n.error(b.data.message,""):n.error("Service is currently unavailable. please, try again later.")),o.go("merchant.airlines.search")})},1e3)},d.load=!1}]),c.module("esewaPaymentApp").controller("FlightDetailsController",["$scope","$rootScope","$modalInstance","individualFlightDetail","totalPassenger","totalPayingAmount",function(a,b,c,d,e,f){a.individualFlightDetail=d,a.totalPassenger=e,a.totalPayingAmount=f,a.closeFlightDetailPanel=function(){c.dismiss()},b.currentModal=c}]),c.module("esewaPaymentApp").controller("PassengerDetailController",["$scope",function(a){a.title=["MR","MS"]}]),c.module("esewaPaymentApp").controller("SingleDateRangeController",["$scope",function(a){a.today=new Date;var b=new Date,c=function(a){a.preventDefault(),a.stopPropagation()};a.openDepartureDate=function(b){c(b),a.departureDateOpened=!0,a.arrivalDateOpened=!1},a.openArrivalDate=function(b){c(b),a.arrivalDateOpened=!0,a.departureDateOpened=!1},a.openCheckInDate=function(b){c(b),a.checkInDateOpened=!0,a.checkOutDateOpened=!1},a.openCheckOutDate=function(b){c(b),a.checkOutDateOpened=!0,a.checkInDateOpened=!1},a.maxDateRange=b.setMonth(b.getFullYear()+1)}]),c.module("esewaPaymentApp").service("AirlineCalculator",function(){this.getTotalPayingAmount=function(a,b){return 1*a-1*b},this.getPassengerList=function(a,b){var c=[];return a&&_.forEach(a,function(a,d){c[d]={passenger_type:b,title:a.tlt?a.tlt:"MR",gender:"Mr"===a.tlt?"MALE":"FEMALE",first_name:a.firstName,last_name:a.lastName,nationality:a.nationality?a.nationality:"NEPAL",passenger_remarks:"remarks"}}),c},this.getBaseFare=function(a,b,c,d){return 1*a*(1*b+1*c+1*d)},this.getFuelSurchargeFare=function(a,b,c,d){return 1*a*(1*b+1*c+1*d)},this.getFilteredDate=function(a,b,c){var d=[];if(b)for(var e=0;e<b.length;e++)for(var f=0;f<a.length;f++)b[e].airline_code===a[f].code&&(c?new Date(b[e].flight_date+" "+b[e].arrival_time)>=new Date(c.flight_date+" "+c.arrival_time)&&d.push(b[e]):d.push(b[e]));return d.sort(function(a,b){return a-b})},this.getFilteredDateByPrice=function(a,b){var c=[];if(b)for(var d=0;d<b.length;d++)b[d].total_amount<a&&c.push(b[d]);return c},this.getFilteredAirlinesByPrice=function(a,b){for(var c=[],d=0;d<b.length;d++)for(var e=0;e<a.length;e++)if(b[d].total_amount>=a[e].total_amount){c.unshift(b[d]);break}return c},this.getReturnFlightList=function(a,b){var c=[];if(b)for(var d=0;d<b.length;d++)a===b[d].airline_name&&c.push(b[d]);return c}}),c.module("esewaPaymentApp").service("AirlinePassengerDetailService",[function(){this.getAirlinePassengerDetail=function(a){var b,c,d=[];for(c=0;c<a.totalPax;c++)b={},b.name=a["passengerName_"+c],b.ticketNumber=a["outboundTicketNo_"+c],b.sector=a.outboundSector,b.passsengerType=a["passengerType_"+c],b.gender=a["passengerGender_"+c],b.passengerNationality=a["passengerNationality_"+c],d.push(b);return d},this.getAirlineReturnPassengerDetail=function(a){var b,c,d=[];for(c=0;c<a.totalPax;c++)b={},b.name=a["passengerName_"+c],b.ticketNumber=a["inboundTicketNo_"+c],b.sector=a.inboundSector,b.passsengerType=a["passengerType_"+c],b.gender=a["passengerGender_"+c],b.passengerNationality=a["passengerNationality_"+c],d.push(b);return d}}]),c.module("esewaPaymentApp").service("AirlinesService",["Restangular",function(a){this.getSector=function(){return a.all("airlines").one("sector").get()},this.getAirlines=function(){return a.one("airlines").get()},this.getAirlinesAvailabilities=function(b){var c=b.origin,d=b.destination,e=b.trip_type.key;return a.one("auth").all("airlines").one("availabilities").get({airline_code:b.airline_code,destination:d,origin:c,flight_date:b.flight_date,no_of_adult:b.no_of_adult,no_of_child:b.no_of_child,return_date:b.return_date,trip_type:e})},this.makeFlightPayment=function(b){return a.one("auth").one("make_payment").one("airline").customPOST(b)},this.getLeadPassengerDetail=function(){return a.one("auth").one("detail").get()},this.reserveFlight=function(b){return a.one("auth").one("airlines").one("reserve").customPOST(b)},this.sendNotificationToSms=function(b){return a.one("auth").one("airlines").one("ticket").one("notification").one("sms").customPOST(b)},this.sendNotificationToEmail=function(b){return a.one("auth").one("airlines").one("ticket").one("notification").one("email").customPOST(b)}}]),c.module("esewaPaymentApp").service("DateFormatter",function(){this.formatDate=function(a){a&&c.isDefined(a.replace)&&(a=a.replace(/(\d{2})-(\d{2})-(\d{4})/,"$2/$1/$3"));var b=new Date(a),d=""+(b.getMonth()+1),e=""+b.getDate(),f=b.getFullYear();return d.length<2&&(d="0"+d),e.length<2&&(e="0"+e),[f,d,e].join("-")}}),c.module("esewaPaymentApp").service("SingleDateService",function(){this.getFormattedDate=function(a){new Date;return{today:a.toISOString()}}}),c.module("esewaPaymentApp").controller("HotelServiceController",["$scope","$rootScope","$modalInstance","airlines",function(a,b,c,d){a.airlinesServices=d,b.currentModal=c,a.cancel=function(){c.dismiss()},b.currentModal=c}]),c.module("esewaPaymentApp").controller("HotelsController",["$scope","$rootScope","$state","$stateParams","HotelService","DateFormatter","$timeout","StateConstant","$modal","$location","AUTH_EVENTS","$http","FileSaverFactory","StatementService","ecmsg","EsewaCommissionCalculationFactory","MerchantPaymentService","DefaultMessageConstant",function(a,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){function u(b){b&&s.getProductCommission(b).then(function(b){b&&(a.commissionDetail=b.plain())})}function v(){a.commissionDetail={cashBack:0,charge:0,commissionResources:{}}}function w(){this.checkInDate=new Date,this.checkOutDate=new Date,this.checkInDate.setDate(this.checkInDate.getDate()+1),this.checkOutDate.setDate(this.checkOutDate.getDate()+2)}function x(a,b,c){for(var d=0;d<a.length;d++)if(a[d][b]===c)return a[d];return null}d.clearMessage(),a.nationality=["Nepalese","Indian"],a.selectedHotelList=[],d.message={},a.maxAdult=20,a.adults=[],a.openChildAge=!0,a.rooms=[],a.selectedHotel=null,a.minNoOfRooms=1,a.BookingDetails={},a.guest=[],a.noOfNights=1,a.childsAge={},a.noOfnonInfant=0,a.noOfInfant=0;var y=864e5,z="oyo_kathmandu";a.getProductCode=function(){z="Kathmandu"===a.searchRequest.city?"oyo_kathmandu":"oyo_pokhara"},a.commissionDetailService=r,a.getHotelCashBack=function(b){return a.calculateHotelCommission(b),a.commissionDetailService.getCashBack()},a.calculateHotelCommission=function(b){a.commissionDetailService.setCashBackCharge(1*a.commissionDetail.cashBack,a.commissionDetail.commissionResources),a.commissionDetailService.calculateForAmount(1*b)},null===a.selectedHotel&&e.go(j.HOTEL_LIST),a.noOfAdultChange=function(){a.maxChild=3*a.searchRequest.numberOfAdults,a.searchRequest.childs=[],a.searchRequest.noOfChild=0,a.searchRequest.noOfAdult=a.searchRequest.numberOfAdults;for(var b=0;b<a.maxChild;b++)a.searchRequest.childs.push({id:b,age:0});a.DefineRooms()},a.populateAdult=function(){a.minNoOfRooms=1,a.searchRequest.childs=[],a.rooms=[];for(var b=1;b<=a.maxAdult;b++)a.adults.push({id:b}),b<=4&&a.searchRequest.childs.push({id:b-1,age:0});a.rooms.push({id:1})},a.closeChildAge=function(){a.openChildAge=!1,a.DefineRooms()},a.reopenChildAge=function(){a.openChildAge=!0},a.calculateInfant=function(){a.noOfnonInfant=0;for(var b=1;b<=a.searchRequest.noOfChild;b++)a.childsAge[b]<5?a.noOfInfant++:a.childsAge[b]>=5&&a.noOfnonInfant++;a.DefineRooms()},a.DefineRooms=function(){0===a.searchRequest.noOfChild&&(a.noOfnonInfant=0),a.noOfnonInfant>0?(a.noOfTAdults=a.searchRequest.numberOfAdults+a.noOfnonInfant,a.minNoOfRooms=Math.floor(a.noOfTAdults/3),a.maxNoOfRooms=a.noOfTAdults):(a.noOfTAdults=a.searchRequest.numberOfAdults,a.minNoOfRooms=Math.floor(a.searchRequest.numberOfAdults/3),a.maxNoOfRooms=a.searchRequest.noOfAdult),a.noOfTAdults%3>0&&a.minNoOfRooms++,a.searchRequest.noOfRooms=a.minNoOfRooms,a.rooms=[];for(var b=a.minNoOfRooms;b<=a.maxNoOfRooms;b++)a.rooms.push({id:b})},a.closeThis=function(){a.openChildAge=!1},a.childAgeChange=function(){},a.noOfChildChange=function(){a.childsAge={},a.searchRequest.childs=[];for(var b=0;b<=a.searchRequest.noOfChild;b++)a.searchRequest.childs.push({id:b,age:0});a.searchRequest.noOfChild>=1&&(a.openChildAge=!0)},a.CheckDate=function(){if(a.searchRequest.dateRange.checkOutDate<=a.searchRequest.dateRange.checkInDate){var b=Date.parse(a.searchRequest.dateRange.checkInDate),c=b+y;a.searchRequest.dateRange.checkOutDate=new Date(c)}},a.cancelHotelBooking=function(){e.go(j.HOTEL_LIST)};var A=new Date;a.title=["Mr","Ms","Mrs"],a.showSameMessage=!1,a.showloadingBar=!1,a.datePicker={startDate:A},a.searchRequest={checkOutDate:"",checkInDate:"",dateRange:new w,noOfAdult:1,noOfChild:0,noOfInfant:"",childAge:{}},a.getHotelsAvailability=function(){g.getHotelsAvailabilities(a.searchHotelDto).then(function(b){d.message.error=null,a.availableHotels=b.plain(),a.searchedHotels=a.availableHotels.Hotels.Hotel,a.totalHotelCount=a.availableHotels.Hotels.Hotel.length,a.showloadingBar=!1,a.searchedHotels&&0!==a.totalHotelCount?a.totalHotelCount=a.availableHotels.Hotels.Hotel.length:(d.showInformation=!1,d.message.error="No Hotels available on this searched criteria. Please, select other options")},function(b){a.showloadingBar=!1,a.showMessage="No data available",d.showInformation=!1,c.isDefined(b)&&(b.data.error_message?d.message.error=b.data.error_message:d.message.error="Hotels are not available with provided search parameters.")})},a.findHotels=function(){v(),a.showloadingBar=!0,a.searchRequest.ChildAge={};for(var b=1;b<=a.searchRequest.noOfChild;b++){var c="child_"+b+"_age";a.searchRequest.ChildAge[c]=a.childsAge[b]}var d=a.searchRequest.noOfChild;a.searchRequest.noOfChildRequest=a.searchRequest.noOfChild;for(var e=1;e<=d;e++)a.childsAge[e]>5&&(a.searchRequest.noOfAdult++,a.searchRequest.noOfChildRequest--);a.findHotelsFromServer(),u(z),a.searchedHotels=[]},a.findHotelsFromServer=function(){a.searchHotelDto={checkInDate:h.formatDate(a.searchRequest.dateRange.checkInDate),checkOutDate:h.formatDate(a.searchRequest.dateRange.checkOutDate),adults:a.searchRequest.noOfAdult,rooms:a.searchRequest.noOfRooms,noOfChild:a.searchRequest.noOfChildRequest,mobileNumber:a.searchRequest.mobileNumber,cancellationPolicy:!0,city:a.searchRequest.city,childAge:a.searchRequest.ChildAge},a.getHotelsAvailability()},a.getHotelDetails=function(b,c){a.guest=[],c&&(a.selectedHotelCashBack=c),a.noOfNights=Math.round((a.searchRequest.dateRange.checkOutDate-a.searchRequest.dateRange.checkInDate)/1e3/60/60/24),e.go(j.HOTEL_DETAILS,{hotel_id:b}),g.getHotelDeals(b).then(function(c){if(null===c)e.go(j.HOTEL_LIST),d.message.error="Hotel details cannot be obtained at the moment. Please, Try again later.";else{a.selectedHotel=c[0],a.HotelDetails=x(a.searchedHotels,"id",b),a.selectedHotelImages=[];for(var f in a.selectedHotel.images)a.selectedHotelImages.push(a.selectedHotel.images[f]);a.totalImage=a.selectedHotelImages.length}},function(a){console.log(a)})},a.confirmHotelBooking=function(){a.showloadingBar=!0;var f=d.$storage.profile.esewaId+"_"+b.performance&&b.performance.now&&b.performance.timing&&b.performance.timing.navigationStart?b.performance.now()+b.performance.timing.navigationStart:Date.now();return a.uniqueId=d.$storage.profile.esewaId+"_"+f,c.isDefined(a.selectedHotel)&&null!==a.selectedHotel?(a.BookingDTO={firstName:a.guest.firstname.trim(),lastName:c.isDefined(a.guest.middlename)?(a.guest.middlename+" "+a.guest.lastname).trim():a.guest.lastname.trim(),phone:a.guest.phone,email:a.guest.email,countryCode:"+977",checkin:a.searchHotelDto.checkInDate,checkout:a.searchHotelDto.checkOutDate,hotelId:a.selectedHotel.id,requestUniqueId:a.uniqueId,singleRoom:1,doubleRoom:0,extraRoom:0,totalGuest:a.searchRequest.noOfAdult,totalRoom:a.searchRequest.noOfRooms},a.BookingDetails={},g.makeHotelBooking(a.BookingDTO).then(function(b){a.showloadingBar=!1,a.BookingDetails=b.plain(),a.selectedHotelCashBack=a.getHotelCashBack(a.BookingDetails.final_amount)},function(b){a.showloadingBar=!1,e.go(j.HOTEL_LIST),d.message.error=b.data.error_message,a.showMessage="No data available"}),void e.go(j.HOTEL_BOOKING)):(a.showloadingBar=!1,void(d.message.error=t.SERVICE_NA))},a.confirmHotelBookingPayment=function(){a.showloadingBar=!0,a.PaymentDTO={amount:a.BookingDetails.final_amount,product_code:z,unique_id:a.BookingDetails.external_reference_id,properties:{id:a.BookingDetails.id,invoice:a.BookingDetails.invoice,checkin:a.BookingDTO.checkin,checkout:a.BookingDTO.checkout,roomCount:a.BookingDTO.noOfRooms,status:"Saved",no_of_guest:a.BookingDTO.noOfAdult+a.BookingDTO.noOfChild,final_amount:a.BookingDetails.final_amount,guest_name:a.BookingDTO.firstName+" "+a.BookingDTO.lastName,country_name:"Nepal",external_reference_id:a.BookingDetails.external_reference_id,currency_symbol:"₹",email:a.BookingDTO.email,phone:a.BookingDTO.phone,hotelName:a.selectedHotel.name,numberOfAdult:a.searchRequest.noOfAdult,numberOfChild:0===a.searchRequest.noOfChild?"N/A":a.searchRequest.noOfChild}},a.PaymentDetails={},g.makeHotelPayment(a.PaymentDTO).then(function(b){a.PaymentDetails=b.plain(),a.showloadingBar=!1,e.go(j.TRANSACTIONS,{txnId:b.transaction_code,moduleId:b.module_id}),d.$broadcast(m.getBalanceAndRewards)},function(b){e.go(j.HOTEL_LIST),a.showloadingBar=!1,a.showMessage="No data available"}),e.go(j.HOTEL_BOOKING)},a.getIcon=function(a){return"Complimentary Breakfast"===a?"fa-coffee":"Amazon Prime"===a?"fa-amazon":"Swimming Pool"===a?"fa-life-ring":"AC"===a||"Mini Fridge"===a?"fa-snowflake-o":"Living Room"===a||"Spa"===a||"Wellness Centre"===a?"fa-bed":"Free Wifi"===a?"fa-wifi":"Kitchen"===a||"Banquet Hall"===a||"Dining Area"===a||"Complimentary Veg Breakfast"===a||"Complimentary Breakfast"===a||"In-house Restaurant"===a?"fa-cutlery":"HDTV"===a||"TV"===a||"Netflix"===a?"fa-television":"Electricity Charges Included"===a||"Power backup"===a?"fa-plug":"Geyser"===a?"fa-sun-o":"Room Heater"===a?"fa-thumbs-up":"Bath Tub"===a?"fa-bath":"Parking Facility"===a?"fa-car":"Card Payment"===a?"fa-credit-card":"Lift/Elevator"===a?"fa-arrows-v":"Conference Room"===a?"fa-users":"Wheelchair Accessible"===a?"fa-wheelchair":"Laundry"===a?"fa-tint":"Bar"===a?"fa-glass":"Kindle"===a?"fa-tablet":"Pet Friendly"===a?"fa-paw":"CCTV Cameras"===a?"fa-video-camera":"fa-thumbs-up"}}]),c.module("esewaPaymentApp").service("HotelService",["Restangular",function(a){this.getHotelDeals=function(b){return a.one("auth").all("hotel").one("oyo").one(b).get()},this.getHotelsAvailabilities=function(b){return a.one("auth").all("hotel").one("oyo").one("availabilities").customPOST(b)},this.makeHotelBooking=function(b){return a.one("auth").all("hotel").one("oyo").one("booking").customPOST(b)},this.makeHotelPayment=function(b){return a.all("auth").one("make_payment").customPOST(b)}}]),c.module("esewaPaymentApp").controller("BankController",["$scope","$rootScope","$state","BankService","EsewaCommissionCalculationFactory","AUTH_EVENTS","NewTransactionDetail","$modal","DefaultMessageConstant","$filter","$window","$localStorage","$http",function(a,b,e,f,g,h,i,j,k,l,m,n,o){function p(b){f.getUserSavedBankList().then(function(c){a.userSavedBankList=r(b,c.plain())},function(a){t(a)})["finally"](function(){a.netBankList=q(a.userSavedBankList.concat(b)),s(!1)})}function q(a){var b=[];return c.forEach(a,function(a,d){c.isDefined(a.is_personal_account)?a.accountType=a.is_personal_account?"My Account":"Circular Accounts":a.accountType="Banks",b.push(a)}),b}function r(a,b){var d=[];return c.forEach(b,function(b,c){for(var e=0;e<a.length;e++)b.swift_code===a[e].swift_code&&(b.bank_display_name=a[e].bank_display_name+" ",b.max_amount=a[e].max_amount,b.min_amount=a[e].min_amount,d.push(b))}),d}function s(b){a.showloadingBar=b}function t(a){console.log(a)}function u(){a.bankValidationSuccessMsg=!1}function v(){a.paymentRequest={amount:"",remarks:"",account_holder_name:"",destination_account_number:""},a.selectedPurpose="",a.showRemarks=!1}function w(){a.paymentRequest.selectedBankForWithdraw=d,a.isAcNameAndNumberDisabled=!1}a.showRemarks=!1,a.getBankList=function(){s(!0),f.getBankListForWithdraw().then(function(a){n.user||{};p(a.plain())},function(a){})["finally"](function(){s(!1)})},a.setRemarks=function(b){a.showRemarks=!1,"Others"===b?(a.paymentRequest.remarks="",a.showRemarks=!0):a.paymentRequest.remarks=b},a.getPurpose=function(b){var d="/api/web/auth/"+b+"/purpose";o({method:"GET",url:d}).then(function(b){a.purpose=b.data},function(a){c.isDefined(a.data.error_message)&&ecmsg.info(a.data.error_message)})},a.getPurpose("WITHDRAW"),a.disableSubmit=!1,c.isDefined(b.$storage.profile)||b.$storage.profile.isVerified||e.go("main.landing"),v(),a.paymentConfirmation=!1,a.commissionDetailService=g,a.productDetails={},a.bankCommission=function(){if(a.paymentRequest.swift_code){for(var c in a.bankList)a.bankList[c].swift_code===a.paymentRequest.swift_code&&(a.productDetails.bank_display_name=a.bankList[c].bank_display_name);f.getBankWithdrawCommission(a.paymentRequest.swift_code).then(function(b){a.commissionDetailService.setCashBackCharge(0,b.commissionResources)},function(a){b.message=k.SOMETHING_WENT_WRONG}),a.processAmount()}},a.commissionProcessorResource={swift_code:"",account_name:"",account_number:"",amount:""},a.agentBankCommission=function(){if(a.commissionDetailService.resetCommission(),a.paymentRequest.swift_code){for(var c in a.bankList)a.bankList[c].swift_code===a.paymentRequest.swift_code&&(a.productDetails.bank_display_name=a.bankList[c].bank_display_name);a.paymentRequest.swift_code&&a.paymentRequest.account_holder_name&&a.paymentRequest.destination_account_number&&a.paymentRequest.amount&&(a.commissionProcessorResource={bank_code:a.paymentRequest.swift_code,account_holder_name:a.paymentRequest.account_holder_name,account_number:a.paymentRequest.destination_account_number,amount:a.paymentRequest.amount},f.checkAgentBankWithdrawCommission(a.commissionProcessorResource).then(function(c){a.serviceChargeResponse=c.plain(),a.paymentRequest.selectedBankForWithdraw=a.paymentRequest.selectedBankForWithdraw||{},a.paymentRequest.selectedBankForWithdraw.max_amount&&(a.maxAmount=a.getMaxAmount(a.paymentRequest.selectedBankForWithdraw.swift_code),a.minAmount=a.getMinAmount(a.paymentRequest.selectedBankForWithdraw.swift_code)),a.serviceChargeResponse.is_service_charge?f.getBankWithdrawCommissionForAgent(a.commissionProcessorResource).then(function(b){a.commissionDetailService.setCashBackCharge(0,b.commissionResources),a.processAmountForAgents(b.tdsPercentage)},function(a){b.message=k.SOMETHING_WENT_WRONG}):a.processAmount()},function(a){b.message=k.SOMETHING_WENT_WRONG}))}},a.processAmount=function(){a.paymentRequest.selectedBankForWithdraw.swift_code&&(g.calculateForAmount(a.paymentRequest.amount),g.getTotalPayingAmount(),g.getCharge(),a.$$phase||a.$apply())},a.processAmountForAgents=function(b){a.paymentRequest.selectedBankForWithdraw.swift_code&&(g.calculateForAmount(a.serviceChargeResponse.chargeable_amount),g.getCharge(),g.setCashBackChargeAndTds(b),g.getTds(),g.getTotalPayingAmountForAgent(),a.$$phase||a.$apply())},a.validateBankAccount=function(){b.message={};var c={bank_code:a.paymentRequest.swift_code,account_number:a.paymentRequest.destination_account_number,account_holder_name:a.paymentRequest.account_holder_name};a.showloadingBar=!0,f.validateBankAccount(c).then(function(b){y(b.message,b.code,a.paymentRequest)},function(b){var c=b.hasOwnProperty("data")?b.data.error_message||b.data.message:k.SERVICE_NA;y(c,!1,a.paymentRequest)})["finally"](function(){a.showloadingBar=!1})},a.showPaymentConfirmation=function(){return n.user&&n.user.isAgentWithdraw?"main.agentBankWithdraw.confirm"===e.current.name:"main.bankWithdraw.confirm"===e.current.name},a.makeBankWithdraw=function(){u(),a.disableSubmit=!0,a.showloadingBar=!0;var c=Object.assign({},a.paymentRequest);c.bank_code=c.swift_code,f.bankWithdraw(c).then(function(a){e.go("merchant.transaction",{txnId:a.transaction_code,moduleId:a.module_id}),x(a),b.$broadcast(h.getBalanceAndRewards)},function(c){b.message.error=c.hasOwnProperty("data")?c.data.error_message||c.data.message:k.PAYMENT_FAILED,b.message.error&&(a.paymentConfirmation=!1,w())})["finally"](function(){a.showloadingBar=!1,a.disableSubmit=!1,v()})};var x=function(a){i.amount=a.amount,i.properties=a.properties,i.narration=a.narration,i.requestUniqueId=a.requestUniqueId,i.channel=a.channel,i.transaction_status=a.transaction_status,i.created=a.created,i.product_logo_url=a.product_logo_url,i.product_name=a.product_name,i.processed_by=a.processed_by};a.showConfirmationView=function(){a.validateBankAccount()},a.cancelPayment=function(){w(),v(),a.paymentConfirmation=!1,b.clearMessage(),a.invalidFormMessage="",a.trustedHtml="",a.showInformation=!1,e.go("^")};var y=function(b,c,d,e){j.open({templateUrl:"/user/merchant/payments/views/account_validation_dialog.html",size:"md",controller:z,scope:a,resolve:{paymentRequest:function(){return d},message:function(){return b},successBtnText:function(){return c===-1?"":0===c?"PROCEED":"CONTINUE ON YOUR OWN RISK"},makeBankWithdraw:function(){return e}}})},z=["$scope","paymentRequest","successBtnText","message","AUTH_EVENTS","$rootScope","$modalInstance","makeBankWithdraw","$window","$filter","$localStorage",function(a,b,c,d,g,h,i,j,k,l,m){h.currentModal=i,a.cancel=function(){m.user&&m.user.isAgentWithdraw?e.go("main.agentBankWithdraw"):e.go("main.bankWithdraw"),i.dismiss(),f.setConfrimation(!1)},a.proceed=function(){k.scrollTo({top:0,behavior:"smooth"}),b.selectedBankForWithdraw=b.selectedBankForWithdraw.bank_display_name,b.accountValidationMessage=d,b.account_holder_name=l("reverse_camel_case")(b.account_holder_name.toLocaleLowerCase()),i.dismiss(),f.setConfrimation(!0),c&&(a.$parent.paymentConfirmation=!0,m.user&&m.user.isAgentWithdraw?e.go("main.agentBankWithdraw.confirm"):e.go("main.bankWithdraw.confirm"),a.stepLast=!0)},a.message=d,a.successBtnText=c,a.makeBankWithdraw=j}];a.reset=function(){v(),w(),a.hideInitialCofirmation=!0,b.clearMessage(),a.invalidFormMessage="",a.trustedHtml="",a.showInformation=!1},a.getAccountRegex=function(b){var c=_.filter(a.bankList,{swift_code:b})[0];return c?c.account_regex:"/^[a-zA-Z0-9-]{3,30}$/"},a.getMinAmount=function(b){var c=_.filter(a.bankList,{swift_code:b})[0];return c?c.min_amount:1},a.getMaxAmount=function(b){var c=_.filter(a.bankList,{swift_code:b})[0];return c?c.max_amount:1e5},a.getBankInstruction=function(b){var c=_.filter(a.bankList,{swift_code:b})[0];return c?c.instruction:""},a.loadAcNoAndName=function(b){a.isAcNameAndNumberDisabled=!1,c.equals(b,{})||(c.isDefined(b.status)&&"ACTIVE"!==b.status&&(ecmsg.error("Service for the selected bank is not available at the moment"),w()),a.paymentRequest.swift_code=b.swift_code,a.paymentRequest.account_holder_name=b.account_name,a.paymentRequest.destination_account_number=b.account_number,b.account_name&&(a.isAcNameAndNumberDisabled=!0))}}]),c.module("esewaPaymentApp").controller("MerchantPaymentController",["$scope","$rootScope","$state","$stateParams","MerchantPaymentService","ecmsg","$timeout","$http","EsewaCommissionCalculationFactory","AUTH_EVENTS","CDNUrl","NewTransactionDetail","$sce","$location","StateConstant","PropertyConstant","ValidationService","PropertyOrderFactory","PaymentFormStaticUrlFactory","WuContants","PaymentValidationService","ProductCodeConstant","DefaultMessageConstant","$filter",function(a,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z){function A(b){if(b){if(b===r.airlineProductCode)return void p.path("/airlines");"oyo_kathmandu"!==b&&"oyo_pokhara"!==b&&"OYO"!==b||e.go("merchant.hotels.search"),b!==r.topup&&B(b),a.htmlLinkForProduct=u.getPaymentFormUrl(b),a.stepLast=u.getStepLast(b)}}function B(b){g.getProductDetails(b).then(function(a){C(a)},function(a){D(a)}),a.stepLast=!1}function C(b){b?(a.productDetails=b.plain(),a.trustedPaymentDescription=o.trustAsHtml(a.productDetails.shortDescription)):a.productDetails={displayName:f.product_name,name:f.product_name},W(f.product_code)}function D(a){d.message.error=S(a,"ERROR_FETCHING_DATA")}function E(a){e.go(q.TRANSACTIONS,{txnId:a.transaction_code,moduleId:a.module_id}),d.$broadcast(l.getBalanceAndRewards)}function F(a){d.message.error=S(a,"PAYMENT_FAILED")}function G(c){a.showloadingBar=!0;var e=d.$storage.profile.esewaId+"_"+b.performance&&b.performance.now&&b.performance.timing&&b.performance.timing.navigationStart?b.performance.now()+b.performance.timing.navigationStart:Date.now();a.uniqueId=d.$storage.profile.esewaId+"_"+e,c?a.paymentRequest.unique_id=a.uniqueId:a.paymentRequest.unique_id=f.product_code+"#"+e}function H(a){Z(a),e.go(q.TRANSACTIONS,{txnId:a.transaction_code,moduleId:a.module_id}),d.$broadcast(l.getBalanceAndRewards)}function I(b){Y(),V(),f.product_code!==r.topup&&(a.stepLast=!1),h.error(S(b,"PAYMENT_FAILED")),e.reload()}function J(){a.showloadingBar=!1}function K(){var b=[x.DISH_HOME_RECHARGE_CARD,x.NT_RECHARGE_CARD,x.BROADLINK_RECHARGE_CARD,x.SMART_CELL_RECHARGE_CARD,x.UTL_RECHARGE_CARD],c=[x.THE_LAST_RESORT];return _.includes(b,a.paymentRequest.product_code)&&!w.validateRechargeCard(a.paymentRequest)?void(d.message.error=y.INVALID_AMOUNT):_.includes(c,a.paymentRequest.product_code)&&!w.validateAdventurePackage(a.paymentRequest)?void(d.message.error=y.INVALID_AMOUNT):(a.paymentRequest.product_code!==x.LOOP_NETWORK||w.validateLoopNetwork(a.paymentRequest))&&(a.paymentRequest.product_code!==x.KASPERSKY||w.validateKaspersky(a.paymentRequest))?(a.paymentRequest.product_code===x.SIM_TV&&(a.paymentRequest.properties.topupId=a.paymentRequest.properties.customerId),void(a.paymentRequest.product_code!==x.NEPAL_NURSING_COUNCIL_TOKEN&&a.paymentRequest.product_code!==x.NMC_TOKEN||(a.paymentRequest.properties.token=a.paymentRequest.properties.tokenId))):void(d.message.error=y.INVALID_AMOUNT)}function L(){for(var b in a.paymentRequest.properties)if(a.isMap(a.paymentRequest.properties[b]))delete a.paymentRequest.properties[b];else if(_.includes(a.showInTable,b)){var d=[];d=a.paymentRequest.properties[b];for(var e in d)if(a.isMap(d[e])===!0&&d[e]){var f={};f=d[e];for(var g in f)a.paymentRequest.properties[g+"_"+Object.keys(d).indexOf(e)]=f[g]}else a.paymentRequest.properties[e]=d[e];delete a.paymentRequest.properties[b]}else _.includes(a.excludeListInPaymentRequest,b)&&delete a.paymentRequest.properties[b];a.counterType===r.ESEWA_H2O?(a.paymentRequest.properties.counter=a.paymentRequest.properties.counterName,a.paymentRequest.properties.month=a.paymentRequest.properties.monthName,delete a.paymentRequest.properties.monthName,delete a.paymentRequest.properties.counterName,delete a.paymentRequest.properties.customerName):"eSewa_worldlink"===a.paymentRequest.productCode&&(a.paymentRequest.properties.worldlinkUsername=a.paymentRequest.properties.username,delete a.paymentRequest.properties.username),c.isDefined(a.paymentRequest.properties.enquiry)&&delete a.paymentRequest.properties.enquiry}function M(b){a.totalPayingAmount=1*b+1*a.commissionDetailService.getCharge()-1*a.commissionDetailService.getCashBack()}function N(b){a.response=b.plain(),c.isDefined(d.message.error)&&(d.message.error=""),a.response.message?"SAME_USER"!==a.response.status&&(a.trustedHtml=o.trustAsHtml(a.response.message),a.showInformation=!0,d.message={}):a.response.error_message?(a.trustedHtml=o.trustAsHtml(a.response.error_message),a.showInformation=!0):a.showInformation=!1,"ACTIVE"===a.response.status||"UNKNOWN_USER"===a.response.status?(a.receiverFullName=a.response.name,a.paymentConfirmation=!0):"SAME_USER"===a.response.status&&(d.message.error=a.response.message,a.paymentConfirmation=!1),a.response.charge&&a.response.charge>0&&(a.paymentRequest.properties.charge=a.response.charge,a.paymentRequest.properties.isCustomerToAgent=!0,a.paymentRequest.unique_id=a.response.requestUniqueId,a.paymentRequest.amount=a.response.amount,a.extraMessage=!0,a.chargeMessageTxt="You have requested for Fund Transfer to AGENT so you will be charged NPR. "+a.response.charge+" Please click 'Ok' to proceed OR 'Cancel' to abort.")}function O(b){d.showInformation=!1,a.extraMessage=!1,d.message.error=S(b,"ERROR_ON_SERVING_REQUEST")}function P(b,c,d){a.paymentRequest.amount=0,a.paymentRequest.productCode=f.product_code;var e=b.headers;a.showloadingBar=!0,f.product_code===r.FUN_VALLEY&&(e.arrivalDay=z("date")(e.arrivalDay,"dd/MM/yyyy")),g.getExtraProperties(a.paymentRequest.productCode,d,c,e).then(function(a){Q(a,b)},function(a){R(a)})["finally"](function(){a.stepLast=!1,J()})}function Q(b,d){var e=b.plain().details;for(var g in e)if(a.isMap(e[g])===!0&&e[g]){d[g]={};var h=e[g];for(var i in h)d[g][i]=h[i]}else e[g]&&(d[g]=e[g]);if(a.paymentRequest.productCode===x.VIANET&&(e.bills||(a.noPayment=!0)),a.transferProperties(),a.paymentRequest.productCode===x.WORLDLINK_DIRECT_PAY&&a.worldlinkDirectPay(),a.isNeaOnlineForm=a.paymentRequest.productCode===r.neaOnline,a.paymentRequest.properties=t.orderProperties(d,a.orderInFirst,a.orderInLast),c.isDefined(a.paymentRequest.properties.totalDue)&&a.paymentRequest.product_code!==r.EPS_KHANEPANI&&(a.paymentRequest.amount=a.paymentRequest.properties.totalDue),f.product_code===r.FUN_VALLEY&&(a.altSecondStep=!0,a.secondStep=!1),f.product_code===r.CONNECT_PLUS&&(a.productDetails={displayName:a.paymentRequest.properties.instituteName,name:a.paymentRequest.properties.instituteName,logoPath:a.paymentRequest.properties.instituteLogo},a.addAlertMobileNo=!0,a.paymentRequest.properties.dueAmount<0?(a.addAmountField=!0,a.extraMessage=!0,a.extraMessageTxt="User already has Rs. "+a.paymentRequest.properties.dueAmount*-1+" in advance. Do you still want to pay as advance?"):0===e.dueAmount?a.addAmountField=!0:a.paymentRequest.amount=a.paymentRequest.properties.dueAmount),a.secondStep=!0,a.secondStepConfirmation=!0,c.isDefined(a.paymentRequest.properties.statement)){var j=[];j=a.paymentRequest.properties.statement;for(var k in j)for(var l in k)for(var m in j[k])"date"===m&&(j[k][m]=z("date")(j[k][m],"dd/MM/yyyy"));a.paymentRequest.properties.detail=j,delete a.paymentRequest.properties.statement,c.isDefined(a.paymentRequest.properties.detail)&&(a.paymentRequest.properties.statementSize=a.paymentRequest.properties.detail.length)}c.isDefined(a.paymentRequest.properties.detail)&&(a.paymentRequest.properties.table=t.createTable(a.paymentRequest.properties.detail)),a.paymentRequest.productCode===r.FUN_VALLEY&&(a.secondStep=!1)}function R(b){d.message.error=S(b,"USER_NOT_FOUND"),a.secondStep=!1,a.secondStepConfirmation=!1}function S(a,b){return a&&c.isDefined(a.data.error_message||a.data.message||a.data.errorMessage)?a.data.error_message||a.data.message||a.data.errorMessage:T(b)}function T(a){return a?y[a]:null}function U(a,b){return"object"!=typeof a||"object"!=typeof b?void 0:(c.forEach(b,function(b,c){a.key=b}),a)}function V(){a.paymentRequest={amount:0,unique_id:"",properties:{enquiry:""},product_code:f.product_code}}function W(b){b&&b!==r.merchantBalanceTransfer&&g.getProductCommission(b).then(function(b){b&&(a.commissionDetailService.setCashBackCharge(1*b.cashBack,b.commissionResources),a.commissionDetailService.calculateForAmount(1*a.paymentRequest.amount))})}function X(){a.commissionDetail={cashBack:0,charge:0,commissionResources:{}}}function Y(){a.showloadingBar=!1,a.noPayment=!1,a.extraMessage=!1,a.secondStep=!1,a.addAlertMobileNo=!1,a.addAmountField=!1,a.propertyResponse={},a.propertyTable={},a.disablePayment=!1,a.trustedPaymentDescription="",a.stepLast=!0,a.paymentConfirmation=!1,a.paymentMenuDescription=""}Y(),A(f.product_code),X(),V(),a.loadNeaCounter=function(){a.showloadingBar=!0,g.getNeaCounter().then(function(b){a.counterList=b.plain()},function(a){d.message.error=S(a,"ERROR_FETCHING_DATA")})["finally"](function(){J()})},d.clearMessage(),a.commissionDetailService=k,a.setValueFor=function(b,d){a.isMap(b)&&("table"===d?c.copy(b,a.propertyTable):c.copy(b,a.propertyResponse))},a.getPurpose=function(b){var d="/api/web/auth/"+b+"/purpose";j({method:"GET",url:d}).then(function(b){a.purpose=b.data},function(a){c.isDefined(a.data.error_message)&&h.info(a.data.error_message)})},a.getKhanepaniCounters=function(){a.isWatermarkCounter=!0;var b="/api/web/khanepani/counters";j({method:"GET",url:b}).then(function(b){a.showloadingBar=!1,a.khanepaniCounters=b.data},function(b){a.showloadingBar=!1,c.isDefined(b.data.error_message)&&h.info(b.data.error_message)})},a.getSkyInquiryType=function(){a.skyInquiryType=null,a.skyServiceCode=f.product_code,a.skyServiceCode==r.SKY_TV?a.skyInquiryType="TV":a.skyServiceCode==r.SKY_WALLET?a.skyInquiryType="Wallet":a.skyServiceCode==r.SKY_INTERNET&&(a.skyInquiryType="Internet")},a.getKhanepaniCounterCode=function(b){c.isDefined(b)&&_.forEach(a.khanepaniCounters,function(c){c.productCode===b&&(a.counterCode=c.value,a.counterType=c.type,a.counterType===r.ESEWA_WATERMARK?a.isWatermarkCounter=!0:a.isWatermarkCounter=!1)})},a.getProductDetailsForOption=function(b){c.isDefined(b)&&(g.getProductDetails(b).then(function(b){b?(a.productDetails=b.plain(),a.trustedPaymentDescription=o.trustAsHtml(a.productDetails.shortDescription)):a.productDetails={displayName:f.product_name,name:f.product_name}},function(a){d.message.error=S(errorResponse,"ERROR_FETCHING_DATA")}),W(b))},a.balanceTransfer=function(){X(),c.isDefined(a.paymentRequest.properties.isCustomerToAgent)?c.isDefined(a.paymentRequest.properties.isCustomerToAgent)&&(a.showloadingBar=!0,a.paymentRequest.properties.isCustomerToAgent&&(a.paymentRequest.properties.requestUniqueId=a.paymentRequest.unique_id)):a.paymentRequest.properties.isCustomerToAgent||G(),g.fundTransfer(a.paymentRequest).then(function(a){E(a)},function(a){F(a)})["finally"](function(){J()})},a.processPayment=function(){G(a.paymentRequest),g.makePayment(a.paymentRequest).then(function(a){H(a)},function(a){I(a)})["finally"](function(){J()})},a.makePayment=function(){a.confirmPageMessage="",d.message={},K(),a.invalidFormMessage="",a.trustedHtml="",d.disableSubmit=!0,a.paymentRequest.product_code===r.neaOnline&&(a.paymentRequest.properties.numberOfMonth=a.paymentRequest.properties.detail.length),f.product_code===r.MERO_TV&&(a.paymentRequest.properties.selectedPackage=a.paymentRequest.properties.selectedPackageId,delete a.paymentRequest.properties.selectedPackageId),L(),a.paymentRequest.product_code===r.merchantBalanceTransfer?a.balanceTransfer():a.processPayment()};var Z=function(a){n.amount=a.amount,n.properties=a.properties,n.narration=a.narration,n.request_unique_id=a.request_unique_id,n.channel=a.channel,n.transaction_status=a.transaction_status,n.created=a.created,n.product_logo_url=a.product_logo_url,n.product_name=a.product_name,n.processed_by=a.processed_by};e.current.name===q.MAKE_PAYMENT&&f.product_code!==r.merchantBalanceTransfer&&W(f.product_code),a.calculateCommission=function(a){W(a)},a.$watch("paymentRequest.amount",function(b){b>0&&a.commissionDetailService.calculateForAmount(b)}),a.cancelPayment=function(){e.reload()},a.checkBalance=function(b){return a.hideError=!1,c.isUndefined(a.paymentRequest.amount)?(a.hideError=!0,!0):!!(c.isDefined(b)&&a.paymentRequest.amount>=b.minimumAmount&&(a.paymentRequest.amount<=b.maximumAmount||0===b.maximumAmount)&&(M(a.paymentRequest.amount),c.isDefined(a.paymentRequest.amount)&&c.isDefined(d.userBalance)&&a.paymentRequest.amount>d.userBalance))||void 0},a.validateForm=function(b){if(a.invalidFormMessage="",a.paymentRequest.amount&&c.isDefined(b)){if(1*a.paymentRequest.amount>0!=!0)return a.invalidFormMessage=y.INVALID_AMOUNT,!1;if(a.paymentRequest.amount<b.minimumAmount||b.maximumAmount&&a.paymentRequest.amount>b.maximumAmount)return a.invalidFormMessage="Amount must be less than or equals to "+b.maximumAmount+" and more than or equals to "+b.minimumAmount,!1}return!0},d.$on(l.getProductCommission,function(){W(f.product_code)}),a.doValidateFundTransfer=function(){g.validateFundTransfer(a.validateFundTransfer).then(function(a){N(a)},function(a){O(a)})["finally"](function(){J()})},a.filterPropertiesForTwoStep=function(){f.product_code===r.FUN_VALLEY&&(a.paymentRequest.properties.arrivalDay=z("date")(a.paymentRequest.properties.arrivalDay,"MM/dd/yyyy")),f.product_code===x.WORLDLINK_DIRECT_PAY?c.isDefined(a.paymentRequest.properties.response.message)&&(a.confirmPageMessage=a.paymentRequest.properties.response.message):f.product_code===x.VIANET?c.isDefined(a.paymentRequest.properties.profile)&&(a.paymentRequest.properties.customerName=a.paymentRequest.properties.profile.customer_name):a.counterType===r.ESEWA_H2O?(a.paymentRequest.properties.counterName=a.paymentRequest.properties.counter,a.paymentRequest.properties.monthName=a.paymentRequest.properties.month,delete a.paymentRequest.properties.counter,delete a.paymentRequest.properties.month):f.product_code===r.MERO_TV?(delete a.paymentRequest.properties.packages,delete a.paymentRequest.properties.subscriber,delete a.paymentRequest.properties.enquiry):f.product_code===r.NET_TV?(delete a.paymentRequest.properties.channelPackage,delete a.paymentRequest.properties.user):f.product_code===r.TU_TOKEN_PAYMENT?delete a.paymentRequest.properties.amount:a.paymentRequest.productCode===r.SKY_INTERNET||a.paymentRequest.productCode===r.SKY_TV?delete a.paymentRequest.properties.packages:f.product_code===r.ARROWNET_ISP?delete a.paymentRequest.properties.payload:f.product_code===r.TECHMIND_ISP?(delete a.paymentRequest.properties.amount,delete a.paymentRequest.properties.properties,delete a.paymentRequest.properties.responseCode,delete a.paymentRequest.properties.responseMessage):f.product_code===r.SIM_TV&&delete a.paymentRequest.properties.customerNo},a.showFundTransferConfirmation=function(){if(!a.paymentRequest.amount||1*a.paymentRequest.amount>0!=!0)return!1;a.invalidFormMessage="",a.trustedHtml="",a.productCode=a.paymentRequest.productCode,a.paymentRequest.properties.receiverName&&a.paymentRequest.product_code!==x.TOPUP?a.paymentRequest.properties.receiverEsewaId=a.paymentRequest.properties.receiverName:a.paymentRequest.properties.receiverName&&a.paymentRequest.product_code===x.TOPUP&&(a.paymentRequest.productCode===x.NAMASTE_TOPUP_VOLUME_BASED||a.paymentRequest.productCode===x.NAMASTE_TOPUP_UNLIMITED||a.paymentRequest.productCode===x.NAMASTE_LANDLINE?a.paymentRequest.properties.landLineNo=a.paymentRequest.properties.receiverName:a.paymentRequest.properties.mobileNumber=a.paymentRequest.properties.receiverName),a.paymentConfirmation=!0,W(a.productCode),f.product_code===r.merchantBalanceTransfer&&(a.paymentConfirmation=!1,a.validateFundTransfer={receiver_name:a.paymentRequest.properties.receiverName,amount:a.paymentRequest.amount},a.showloadingBar=!0,a.doValidateFundTransfer()),a.filterPropertiesForTwoStep();for(var b in a.paymentRequest.properties)"enquiry"===a.paymentRequest.properties[b]&&""===a.paymentRequest.properties[b]&&delete a.paymentRequest.properties[b];for(var c in a.paymentRequest.properties){if(!a.isMap(a.paymentRequest.properties[c])){var d=a.paymentRequest.properties[c];a.paymentRequest.properties[c]=d}a.isMap(a.paymentRequest.properties[c])&&delete a.paymentRequest.properties[c],a.paymentRequest.properties[c]||delete a.paymentRequest.properties[c]}a.isNeaOnlineForm&&a.paymentRequest.amount!=a.paymentRequest.properties.totalDue&&(a.paymentRequest.properties.advanceAmount=a.paymentRequest.amount-a.paymentRequest.properties.totalDue)},a.fundTransfer=function(b,c,h,i){a.showloadingBar=!0;r.merchantBalanceTransfer;d.paymentDto={product_code:f.product_code,amount:c,properties:{receiverEsewaId:i},narration:h},g.fundTransfer(d.paymentDto).then(function(b){a.showloadingBar=!1,d.fundTransferDetails=b.plain(),d.message.success=y.SUCCESS_FUND_TRANSFER,d.paymentDto={},e.go(q.FUND_TRANSFER_DETAIL,{txnId:d.fundTransferDetails.transaction_code,moduleId:d.fundTransferDetails.module_id}),d.$broadcast(l.getBalanceAndRewards)},function(){d.showInformation=!1,a.showloadingBar=!1})},a.goToConfirmation=function(){a.showFinalConfirmation=!0,a.showInformation=!1},a.hideInitialCofirmation=!1,a.reset=function(){a.secondStepConfirmation=!1,a.extraMessage=!1,a.noPayment=!1,c.isDefined(a.paymentRequest.properties)&&(c.isDefined(a.paymentRequest.properties.enquiry)?""!==a.paymentRequest.properties.enquiry&&a.paymentRequest.properties.enquiry&&(a.secondStep=!1,a.stepLast=!1):(a.secondStep=!1,c.isDefined(a.paymentRequest.properties.table)&&(a.stepLast=!1))),V(),f.product_code===r.DISH_HOME&&(a.paymentRequest.properties.dishhomeType="cas"),c.isDefined(a.paymentForm)&&a.paymentForm.$setUntouched(),a.hideInitialCofirmation=!0,d.clearMessage(),a.invalidFormMessage="",a.trustedHtml="",a.showInformation=!1,a.addAlertMobileNo=!1,a.addAmountField=!1,a.extraMessage=!1},a.mobileOperator={};var $=[];f.product_code===r.topup&&(j.get(m.url+"/data/topup.json").success(function(a){$=a}),a.productDetails={displayName:"Direct Topup",name:"Direct Topup",shortDescription:"Please enter the phone number.NT Prepaid, NT Postpaid, NT Landline/ADSL, CDMA, Ncell Prepaid, Ncell Postpaid, UTL",logoPath:"/common/icons/payment/direct_topup.png"},a.trustedPaymentDescription=o.trustAsHtml(a.productDetails.shortDescription)),a.getProductCodeForLandline=function(b){"ADSL(Volume based)"===b?(a.paymentRequest.productCode=x.NAMASTE_TOPUP_VOLUME_BASED,a.productDetails.name="Nt ADSL Topup - Volume Based"):"ADSL(Unlimited)"===b?(a.paymentRequest.productCode=x.NAMASTE_TOPUP_UNLIMITED,a.productDetails.name="Nt ADSL Topup - Unlimited"):"LANDLINE"===b&&(a.paymentRequest.productCode=x.NAMASTE_LANDLINE,a.productDetails.name="Nt Landline Payment"),a.landlineOperator=_.find($,function(b){if(b.productCode===a.paymentRequest.productCode)return b}),a.amountList=a.landlineOperator.amounts,W(a.paymentRequest.productCode)},a.getMobileOperator=function(b){!b||b.length<8||s.checkPhoneValid(b)&&(a.mobileOperator=_.find($,function(a){var c=new RegExp(a.regex);if(c.test(b))return a}),a.mobileOperator?("NP-RTP-SMARTCELL"===a.mobileOperator.productCode?(a.textAmount=!1,a.selectAmount=!0,a.amountList=a.mobileOperator.amounts):(a.textAmount=!0,a.selectAmount=!1,a.amountList=[]),!s.checkLandlineValid(b)||b.startsWith("98")||b.startsWith("97")||b.startsWith("96")||(a.landlineOptions=["ADSL(Volume based)","ADSL(Unlimited)","LANDLINE"],a.landlineType=!0,a.textAmount=!0,a.selectAmount=!1),a.paymentRequest.productCode=a.mobileOperator.productCode,a.productDetails.shortDescription=o.trustAsHtml(a.mobileOperator.shortDescription),a.trustedPaymentDescription=o.trustAsHtml(a.mobileOperator.shortDescription),a.productDetails.displayName=a.mobileOperator.displayName,a.productDetails.name=a.mobileOperator.name,a.productDetails.logoPath=a.mobileOperator.logoPath,W(a.paymentRequest.productCode)):a.mobileOperator={})},a.worldlinkDirectPay=function(){a.paymentRequest.properties.response&&(c.isDefined(a.paymentRequest.properties.response.hasDue)&&(a.paymentRequest.properties.response.hasDue?(a.paymentRequest.amount=a.paymentRequest.properties.response.discountedDueAmount,0===a.paymentRequest.amount&&(a.paymentRequest.amount=a.paymentRequest.properties.response.discountedPaymentAmount)):a.paymentRequest.properties.response.acceptAdvancePayment?a.paymentRequest.properties.response.renewOption?a.paymentRequest.amount=0:a.paymentRequest.amount=a.paymentRequest.properties.response.advancePaymentDiscounted:"VOL"===a.paymentRequest.properties.response.handler?a.paymentRequest.amount=0:(a.paymentRequest.amount=0,a.noPayment=!0)),c.isDefined(a.paymentRequest.properties.response.acceptAdvancePayment)&&(a.paymentRequest.properties.acceptAdvancePayment=a.paymentRequest.properties.response.acceptAdvancePayment))},a.transferProperties=function(){a.paymentRequest.properties.amount?a.paymentRequest.amount=a.paymentRequest.properties.amount:a.paymentRequest.properties.grandTotal?a.paymentRequest.amount=a.paymentRequest.properties.grandTotal:a.paymentRequest.properties.finalPayableAmount&&(a.paymentRequest.amount=a.paymentRequest.properties.finalPayableAmount),a.paymentRequest.properties.amount&&(a.paymentRequest.amount=a.paymentRequest.properties.amount),a.paymentRequest.properties.CUSTOMER_ID&&(a.paymentRequest.properties.customerId=a.paymentRequest.properties.CUSTOMER_ID),a.paymentRequest.properties.SCNO&&(a.paymentRequest.properties.scNo=a.paymentRequest.properties.SCNO),a.paymentRequest.properties.OFFICE_ID&&(a.paymentRequest.properties.counter=a.paymentRequest.properties.OFFICE_ID),a.paymentRequest.properties.finalPayableAmount&&(a.paymentRequest.properties.billAmount=a.paymentRequest.properties.finalPayableAmount),a.paymentRequest.properties.paidStatus!==!0&&"2"!==a.paymentRequest.properties.code||(a.noPayment=!0)},a.getDetailPropertiesForOption=function(b,c,e){d.message.error="",a.paymentRequest.amount=0,a.paymentRequest.productCode=b;var f=a.paymentRequest.properties,h=f.headers;a.showloadingBar=!0,g.getExtraProperties(a.paymentRequest.productCode,e,c,h).then(function(a){Q(a,f)},function(a){R(a)})["finally"](function(){a.stepLast=!1,J()})},a.getDetailProperties=function(b,c){d.message.error="",P(a.paymentRequest.properties,b,c)},a.checkButtonDisabled=function(a,b,c,d,e){return a||b||c||d||e},a.isShowable=function(b){return!_.includes(a.getHiddenPropertiesList(),b)},a.isShowableProperties=function(b){return _.includes(a.getHiddenPropertiesDetailsList(),b)},a.isMap=function(a){return"[object Object]"===Object.prototype.toString.call(a)},a.getHiddenPropertiesList=function(){return["productCode","product_code","service","paymentId","receiverName","bills","status","isCustomerToAgent","requestId","code","message","enquiry","CUSTOMER_ID","plan","acceptAdvancePayment","OFFICE_ID","SCNO","finalPayableAmount","headers","detail","table","package","resultCode","dueAmount","instituteLogo","instituteId","resultDescription","monthName","amount","selectedPackageId","statement","office","vendorTransactionId","counter","counterName","date1","date2","classId","packageCode","packageId","noOfDays","tokenId","planCategoryId","response_code","response_message","request_id"]},a.getHiddenPropertiesDetailsList=function(){return["fullClientName"]},a.excludeListInPaymentRequest=["message","grandTotal","detail","product_code","CUSTOMER_ID","OFFICE_ID","SCNO","finalPayableAmount","headers","table","receiverName"],a.orderInFirst=["name","customerId","contact","package"],a.orderInLast=["grandTotal","hidden","Message","USERNAME","finalPayableAmount"],a.showInTable=["detail"],a.loadSecondStepTemplate=function(){var b,c="/user/merchant/payments/views/forms/khanepani_lekhnath.html"===a.htmlLinkForProduct,d="/user/merchant/payments/views/forms/eacademy.html"===a.htmlLinkForProduct;if(c)b="nea_sagarmatha_khanepani";else if(d)b="eAcademy_payment";else switch(f.product_code){case r.VIANET:b="vianet_customer_detail";break;case r.neaOnline:case r.SAGARMATHA_DIRECTPAY:b="nea_sagarmatha_khanepani";break;case r.ITAHARI:b="h2o_khanepani_customer_detail";break;case r.EPS_PAYMENT:case r.EPS_TOKEN:b="woories_customer_detail";break;case r.MERO_TV:b="mero_tv_customer_detail";break;case r.FUN_VALLEY:b="FUN-VALLEY";break;case r.SKY_TV:case r.SKY_INTERNET:case r.SKY_WALLET:b="NP-RTP-SKYTV";break;default:b=f.product_code}a.secondStepTemplateLink="https://cdn.esewa.com.np/ui/html/secondstep/"+b+".html"},a.getWuPurposeAndTransfer=function(){g.getRelationship().then(function(b){a.relationList=b}),g.getTransactionPurpose().then(function(b){a.transactionList=b})},a.getWuReceive=function(){a.showloadingBar=!0,g.getWuTransactionList().then(function(b){if(a.wuTransactions=b.plain(),0===a.wuTransactions.length)return void(a.noData=!0)})["finally"](function(){a.noData=!1,J()})},a.wuTransactions=[],a.wuTransactionsDetails={},a.transactionList={},a.relationList={},a.confirmTransaction=!1,a.proceedTransaction=function(b){a.showloadingBar=!0,a.paymentConfirmation=!0,g.getWuTransaction(b).then(function(b){var c={date:b.date,description:b.description,actual_amount:b.actual_amount,expected_amount:b.expected_amount,transaction_id:b.transaction_id,mobile_number:b.mobile_number,sent_amount:b.sent_amount,originating_country:b.originating_country,attempts_left:b.attempts_left,receipt_code:b.receipt_code};a.wuTransactionsDetails=U(a.wuTransactionsDetails,c),a.confirmTransaction=!0},function(a){d.message.error=S(a)})["finally"](function(){J()})},a.wuPickup={},a.showConfirmation=!1,a.showTransactionQueued=!1,a.showAdditionalInformation=!1,a.showOnHold=!1,a.showFailedMessage=!1,a.showAlreadyPaidOut=!1,a.showMtcnNotFound=!1,a.invalidTransaction=!1,a.otherCase=!1,a.receivedSuccessfully=!1,a.success=!1,a.receiveFailed=!1,a.processPickUp=function(b){a.showloadingBar=!0,g.proceedPickUpWesternUnion(b).then(function(b){a.showloadingBar=!1,a.wuPickup=b.plain(),a.paymentConfirmation=!0,a.getViewByCode(a.wuPickup.code)},function(b){d.message.error=b.data.error_message,a.showloadingBar=!1})},a.processWuReceive=function(b){a.showloadingBar=!0,g.proceedWesternUnionReceive(b).then(function(b){a.showloadingBar=!1,a.wurReciveStatus=b.plain(),"COMPLETE"===a.wurReciveStatus?(e.go("main.wuReceive"),a.paymentConfirmation=!1,a.receivedSuccessfully=!0):a.receiveFailed=!0},function(b){d.message.error=y.SOMETHING_WENT_WRONG,a.showloadingBar=!1})},a.getViewByCode=function(b){b===v.LikelyToBeSuccessful?a.showConfirmation=!0:b===v.LikelyToBeQueued?a.showTransactionQueued=!0:b===v.AdditionalInformationRequired?a.showAdditionalInformation=!0:b===v.FailedPayout?a.showFailedMessage=!0:b===v.OnHold?a.showOnHold=!0:b===v.InvalidTransaction?a.invalidTransaction=!0:b===v.AlreadyPaidOut?a.showAlreadyPaidOut=!0:b===v.MtcnNotFound?a.showMtcnNotFound=!0:a.otherCase=!0},a.confirmPickUp=function(b){a.showloadingBar=!0,g.confrimWesternUnionPickup(b).then(function(b){a.showloadingBar=!1,a.pickupStatus=b.plain(),"COMPLETE"===a.pickupStatus.status?(a.success=!0,a.showConfirmation=!1):(a.showOnHold=!0,a.showConfirmation=!1)},function(){a.showloadingBar=!1})},a.additinalValidate=function(b){a.showloadingBar=!0,g.validateAdditionalWesternUnionDetails(b).then(function(b){a.showloadingBar=!1,a.wuPickup=b.plain(),a.paymentConfirmation=!0,a.getViewByCode(a.wuPickup.code)},function(){a.showloadingBar=!1})},a.cancelWuTransaction=function(){a.paymentConfirmation=!1,a.showConfirmation=!1,a.showTransactionQueued=!1,a.showAdditionalInformation=!1,a.showOnHold=!1,a.showFailedMessage=!1,a.showAlreadyPaidOut=!1,a.showMtcnNotFound=!1,a.invalidTransaction=!1,a.receivedSuccessfully=!1,a.success=!1,a.receiveFailed=!1};var aa="/api/web/auth/midas";a.getClass=function(b){if(f.product_code===r.MIDAS){a.showloadingBar=!0;var e=aa+"/class";j({method:"GET",url:e,params:{mobileNo:b}}).then(function(b){a.classList=b.data,d.message.error="",a.secondStep=!0,a.secondStepConfirmation=!0,a.showloadingBar=!1,console.log(a.classList)},function(b){a.secondStep=!1,a.secondStepConfirmation=!1,a.showloadingBar=!1,(c.isDefined(b.data.error_message)||c.isDefined(b.data.message))&&(d.message.error=b.data.error_message||b.data.message)})["finally"](function(){a.stepLast=!1,J()})}},a.getPackage=function(b){if(f.product_code===r.MIDAS){_.forEach(a.classList,function(c){c.classid===b&&("48"===b?a.paymentRequest.properties["class"]="Nepali Bal Katha":"56"===b?a.paymentRequest.properties["class"]="Bali":"47"===b?a.paymentRequest.properties["class"]="Pasupalan":"83"===b?a.paymentRequest.properties["class"]="Gramin Pasuswasthya Karyakarta Talim":a.paymentRequest.properties["class"]=c.classname)}),a.packageList=null,a.paymentRequest.amount=null,a.packageRate=null,a.showloadingBar=!0;var e=aa+"/class/"+b+"/package";j({method:"GET",url:e,params:{mobileNo:a.paymentRequest.properties.mobileNo}}).then(function(b){a.showloadingBar=!1,a.packageList=b.data,d.message.error=""},function(b){a.secondStep=!1,a.showloadingBar=!1,(c.isDefined(b.data.error_message)||c.isDefined(b.data.message))&&(d.message.error=b.data.error_message||b.data.message),c.isDefined(a.paymentRequest.properties.mobileNo)&&(a.paymentRequest.properties.mobileNo="")})}},a.getPackageRate=function(b){if(f.product_code===r.MIDAS){_.forEach(a.packageList,function(c){c.packagename===b&&(a.paymentRequest.properties.packageId=c.packageid,a.paymentRequest.properties.noOfDays=c.noofdays)});var e=a.paymentRequest.properties.packageId;a.showloadingBar=!0;var g=aa+"/class/package/"+e+"/rate";j({method:"GET",url:g,params:{mobileNo:a.paymentRequest.properties.mobileNo,noOfDays:a.paymentRequest.properties.noOfDays}}).then(function(b){a.showloadingBar=!1,a.packageRate=b.data,d.message.error=""},function(b){a.showloadingBar=!1,(c.isDefined(b.data.error_message)||c.isDefined(b.data.message))&&(d.message.error=b.data.error_message||b.data.message)})}}}]),c.module("esewaPaymentApp").service("BankService",["Restangular",function(a){var b=a.one("auth").one("bank"),c=!1;this.setConfrimation=function(a){c=a},this.getConfrimation=function(){return c},this.esewaLoadBanks=function(b){return a.one("banks").one(b).get()},this.getBankListForWithdraw=function(){return b.one("withdraw").getList()},this.getUserSavedBankList=function(){return a.one("auth").one("bank_information").get()},this.getBankWithdrawCommission=function(a){return b.one("withdraw").one(a).one("commission").get()},this.checkAgentBankWithdrawCommission=function(a){return b.one("withdraw").one("agent/commission/validate").customPOST(a)},this.getBankWithdrawCommissionForAgent=function(a){return b.one("withdraw").one("commission/agent").customPOST(a)},this.bankWithdraw=function(a){return b.all("withdraw").customPOST(a)},this.validateBankAccount=function(a){return b.all("withdraw").all("validate").customPOST(a)}}]),c.module("esewaPaymentApp").service("MerchantPaymentService",["Restangular",function(a){this.makePayment=function(b){return b.productCode&&(b.product_code=b.productCode,delete b.productCode),a.all("auth").one("make_payment").customPOST(b)},this.fundTransfer=function(b){return a.all("auth").one("fund_transfer").customPOST(b)},this.getProductCommission=function(b){return a.one("auth").one("product").one(b).one("commission").customGET()},this.getProductDetails=function(b){return a.one("payment_menus").one("products").one(b).get()},this.validateFundTransfer=function(b){return a.all("auth").one("/fund_transfer/validate").customPOST(b)},this.getExtraProperties=function(b,c,d,e){return a.one("payment").one(b).one("inquiry").one(c).customPOST(e,"",{request_id:d},"")},this.getConversionRate=function(){return a.one("conversion").customGET()},this.getWuTransactionList=function(){return a.one("auth").one("western_union_receive").one("receive").customGET()},this.getWuTransaction=function(b){return a.one("auth").one("western_union_receive/receive").one(b+"").customGET()},this.proceedWesternUnionReceive=function(b){return a.one("auth").one("western_union_receive/proceed").customPOST(b)},this.getRelationship=function(){return a.one("auth").one("western_union_receive/getRelationship").get()},this.getTransactionPurpose=function(){return a.one("auth").one("western_union_receive/getTransactionPurpose").get()},this.proceedPickUpWesternUnion=function(b){return a.one("auth").one("western_union_pickup/validate").customPOST(b)},this.confrimWesternUnionPickup=function(b){return a.one("auth").one("western_union_pickup/proceedPickup").customPOST(b)},this.validateAdditionalWesternUnionDetails=function(b){return a.one("auth").one("western_union_pickup/additional_info").customPOST(b)},this.getNeaCounter=function(){return a.one("nea_counter").getList()}}]),c.module("esewaPaymentApp").service("PaymentValidationService",function(){this.validateRechargeCard=function(a){return a.amount===a.properties.cardFaceValue};var a=[{name:"Bungy or Swing Day Trip",price:"6300"},{name:"Bungy & Swing Day Trip",price:"8500"},{name:"Tandem Day Trip",price:"10700"},{name:"Canyoning Day Trip",price:"5500"},{name:"Rafting Day Trip",price:"3000"},{name:"Bungy & Canyoning Trip",price:"9500"},{name:"Go & See Day Trip",price:"1800"},{name:"Relax at the Resort (1 Night)",price:"4900"},{name:"Relax & Bungy or Swing (1 Night)",price:"9500"},{name:"Relax and Tandem (1 Night)",price:"16800"},{name:"Relax & Rafting (1 Night / 1 Day)",price:"7400"},{name:"Relax & Rafting & Bungy (1 night)",price:"12000"},{name:"Relax & Canyoning (1 Night / 1 Day)",price:"8200"},{name:"Relax & Canyoning (2 Nights / 2 Days)",price:"16700"},{name:"Relax & Canyoning & Bungy (1 Night)",price:"12000"},{name:"Bungy or Swing Only",price:"5200"},{name:"Extra Bungy or Swing",price:"2800"},{name:"Tandem Only",price:"8900"},{name:"Canyoning Only [Day 1]",price:"4200"},{name:"Canyoning Only [Day 2]",price:"8500"},{name:"Sauna",price:"550"},{name:"AP (3 Meals)",price:"3655"},{name:"MAP (2 Meals)",price:"3000"},{name:"BB (1 Meal)",price:"2100"}];this.validateAdventurePackage=function(b){var c=!1;return _.forEachRight(a,function(a){a.name===b.properties.packageType&&a.price*b.properties.noOfPerson===b.amount&&(console.log(a.price*b.properties.noOfPerson),c=!0)}),c},this.validateLoopNetwork=function(a){var b=!1,c=[];return"5 Mbps ( Fall back 512 kbps)"==a.properties["package"]&&(c=[{id:"6933",value:"1 month"},{id:"12865",value:"6 month"},{id:"20210",value:"1 year"}],_.forEachRight(c,function(c){c.value===a.properties.period&&c.id===a.amount&&(b=!0)})),"Basic (768 Kbps)"==a.properties["package"]&&(c=[{id:"6850.01",value:"1 month"},{id:"12187",value:"6 month"},{id:"18515",value:"1 year"},{id:"30832",value:"2 year"}],_.forEachRight(c,function(c){c.value===a.properties.period&&c.id===a.amount&&(b=!0)})),"Budget (512 Kbps)"==a.properties["package"]&&(c=[{id:"6511.01",value:"1 month"},{id:"10153",value:"6 month"},{id:"14447",value:"1 year"},{id:"22696",value:"2 year"}],_.forEachRight(c,function(c){c.value===a.properties.period&&c.id===a.amount&&(b=!0)})),"Gold"==a.properties["package"]&&(c=[{id:"7415.07",value:"1 month"},{id:"15577",value:"6 month"},{id:"25295",value:"1 year"},{id:"44392",value:"2 year"}],_.forEachRight(c,function(c){c.value===a.properties.period&&c.id===a.amount&&(b=!0)})),"Silver (1.5 Mbps)"==a.properties["package"]&&(c=[{id:"7076.01",value:"1 month"},{id:"13543",value:"6 month"},{id:"21227",value:"1 year"},{id:"36256",value:"2 year"}],_.forEachRight(c,function(c){c.value===a.properties.period&&c.id===a.amount&&(b=!0)})),b},this.validateKaspersky=function(a){if("Kaspersky Antivirus 1 Pc/1 User"===a.properties.productName){if("700"===a.amount)return!0}else if("Kaspersky Antivirus 3 Pc / 3 User"===a.properties.productName){if("1225"===a.amount)return!0}else if("Kaspersky Internet Security 1 Pc/1 User"===a.properties.productName){if("1225"===a.amount)return!0}else if("Kaspersky Internet Security 3 Pc/3 User"===a.properties.productName&&"2380"===a.amount)return!0;return!1}}),c.module("esewaPaymentApp").filter("currency",function(){return function(a){return"NPR "+a}}),c.module("esewaPaymentApp").constant("DefaultMessageConstant",{INVALID_AMOUNT:"Invalid transaction amount.",PAYMENT_FAILED:"Payment Failed. Please try again later.",ERROR_ON_SERVING_REQUEST:"Error occurred while serving your request. Please, try again later.",USER_NOT_FOUND:"Username not found",SOMETHING_WENT_WRONG:"Something went wrong. Please, try again later.",ERROR_FETCHING_DATA:"Error while fetching data.",SERVICE_NA:"Service not available.",SUCCESS_FUND_TRANSFER:"Fund transferred successfully."}),c.module("esewaPaymentApp").constant("ProductCodeConstant",{DISH_HOME_RECHARGE_CARD:"DISHHOME",NT_RECHARGE_CARD:"NTGSMRC",BROADLINK_RECHARGE_CARD:"BLRC",SMART_CELL_RECHARGE_CARD:"SMART CELL",UTL_RECHARGE_CARD:"UTLRC",SIM_TV:"NP-RTP-SIMTV",NEPAL_NURSING_COUNCIL_TOKEN:"nnc",NMC_TOKEN:"NMCAPI",WORLDLINK_DIRECT_PAY:"eSewa_worldlink",TOPUP:"TOPUP",NAMASTE_TOPUP_VOLUME_BASED:"NTADV",NAMASTE_TOPUP_UNLIMITED:"NTADS",NAMASTE_LANDLINE:"NTPST",THE_LAST_RESORT:"eSewa_lastresort",LOOP_NETWORK:"LOOP_NETWORK",KASPERSKY:"Kaspersky",VIANET:"eSewa_Vianet"}),c.module("esewaPaymentApp").constant("WuContants",{LikelyToBeQueued:"2000",LikelyToBeSuccessful:"0",AdditionalInformationRequired:"J1002",FailedPayout:"J1000",OnHold:"U2313",InvalidTransaction:"J9999",AlreadyPaidOut:"J1005",MtcnNotFound:"R8774"}),c.module("esewaPaymentApp").factory("EsewaCommissionCalculationFactory",function(){var a=0,b=0,c={},d=0,e=0,f=0,g=function(c,f){e=1*f;var g=0;_.forEach(c,function(c){"PAYER_TO_RECEIVER"===c.transferType||"PAYER_TO_ESEWA"===c.transferType?b=_.round(b+h(c,f),2):"ESEWA_CASHBACK"===c.transferType?g=_.round(g+h(c,f),2):"ESEWA_TO_PAYER"===c.transferType?a=_.round(a+h(c,f),2):"RECEIVER_TO_PAYER"===c.transferType&&(a=_.round(a+h(c,f),2))}),g=_.round(g*d/100,2),a+=g},h=function(a,b){switch(a.commissionType){case"FLAT_AMOUNT":return a.value;case"FLAT_PERCENTAGE":return _.round(b*a.value/100,2);case"RANGE_AMOUNT":return i(a.commissionRangeResources,b);case"RANGE_PERCENTAGE":var c=i(a.commissionRangeResources,b);return _.round(b*c/100,2)}return 0},i=function(a,b){var c=0;return _.forEach(a,function(a){b>=a.low&&(0===a.high||b<=a.high)&&(c=a.value)}),c};return{setCashBackCharge:function(g,h){a=b=e=f=0,c=h,d=g},resetCommission:function(){a=b=e=f=0,c={}},calculateForAmount:function(d){a=b=0,g(c,d)},getCashBack:function(){return a},getCharge:function(){return b},getTds:function(){return f},getTotalPayingAmount:function(){return e+b-a},getTotalPayingAmountForAgent:function(){return e+b-a+f},setCashBackChargeAndTds:function(b){f=0,f=a*(b/100),a=a}}}),c.module("esewaPaymentApp").factory("CurrencyFormatterFactory",function(){}),c.module("esewaPaymentApp").factory("PaymentFormStaticUrlFactory",["PropertyConstant","CDNUrl",function(a,b){function c(c){return c===a.merchantBalanceTransfer?"/user/merchant/payments/views/transfer_fund.html":c===a.wlinkLim?"/user/merchant/payments/views/forms/worldlink/worldlink_direct_pay_lim.html":c===a.wlinkUlim?"/user/merchant/payments/views/forms/worldlink_direct_pay_ul.html":c===a.neaOnline?"/user/merchant/payments/views/forms/NEA_ONLINE.html":c===a.nmcToken?"/user/merchant/payments/views/forms/NMC_Token.html":c===a.NNC||c===a.NAMS?"/user/merchant/payments/views/forms/NNC_Token.html":c===a.VIANET?"/user/merchant/payments/views/forms/vianet/VIANET.html":c===a.KUKLTRBILL?"/user/merchant/payments/views/forms/khanepani_kukl.html":c===a.SAGARMATHA_DIRECTPAY?"/user/merchant/payments/views/forms/Sagarmatha.html":c===a.CONNECT_PLUS?"/user/merchant/payments/views/forms/schoolConnectPlus.html":c===a.EPS_PAYMENT||c===a.EPS_TOKEN?"/user/merchant/payments/views/forms/woorie_eps.html":c===a.DISH_HOME||c===a.NP_RTP_DHOME_RECHARGE?"/user/merchant/payments/views/forms/DishHomeTopup.html":c===a.MERO_TV?"/user/merchant/payments/views/forms/mero_tv.html":c===a.FUN_VALLEY?"/user/merchant/payments/views/forms/funn-valley.html":c===a.KANTIPUR?"/user/merchant/payments/views/forms/kantipur_publication.html":c===a.NET_TV?"/user/merchant/payments/views/forms/net_tv.html":c===a.SKY_TV||c===a.SKY_INTERNET||c===a.SKY_WALLET?"/user/merchant/payments/views/forms/sky_tv.html":c===a.MIDAS?"/user/merchant/payments/views/forms/midas.html":c===a.TU_TOKEN_PAYMENT?"/user/merchant/payments/views/forms/tu_token_payment.html":c===a.NP_ES_KHANEPANI?"/user/merchant/payments/views/forms/khanepani_counter.html":c===a.ARROWNET_ISP?"/user/merchant/payments/views/forms/arrownet_isp.html":c===a.TECHMIND_ISP?"/user/merchant/payments/views/forms/techmind_isp.html":c===a.SIM_TV?"/user/merchant/payments/views/forms/sim_tv.html":c===a.COAL?"/user/merchant/payments/views/forms/generic_token.html":c===a.EACADEMY||c===a.CHAKRESHWOR_SCHOOL||c===a.LITTLE_ANGEL||c===a.ESEWA_ROSY||c===a.JYOTISMATI_SCHOOL||c===a.ESEWA_PARIJAT||c===a.ESEWA_NORTH||c===a.ESEWA_JAINDRA?"/user/merchant/payments/views/forms/eacademy.html":b.url+"/html/"+c+".html"}return{getPaymentFormUrl:function(a){return c(a)},getStepLast:function(b){var c=[a.wlinkLim,a.wlinkUlim,a.lekhnath,a.pragatinagar,a.neaOnline,a.nmcToken,a.DAMAULI,a.PRITHIVI_NARAYAN,a.NNC,a.NAMS,a.INDRAPUR,a.SHIVALAYA,a.JUTPANI,a.SAGARMATHA_DIRECTPAY,a.BALKOT,a.MANGADH,a.EPS_PAYMENT,a.BUDHABARE,a.VIANET,a.CONNECT_PLUS,a.DISH_HOME,a.BELCHAUTARA,a.ITAHARI,a.DADIKOT,a.EPS_TOKEN,a.khandbari,a.MERO_TV,a.BHANSI,a.ANANDABAN,a.MURGIYA,a.SURKHET,a.SHIVNAGAR,a.BARDAGHAT,a.BANGANGA,a.PANCHANAGAR,a.KATUNJE,a.DHULIKHEL,a.LUBHU,a.KAWASHOTI,a.FUN_VALLEY,a.NET_TV,a.SKY_TV,a.NP_RTP_DHOME_RECHARGE,a.MIDAS,a.TU_TOKEN_PAYMENT,a.NP_ES_KHANEPANI,a.SKY_INTERNET,a.SKY_WALLET,a.ARROWNET_ISP,a.TECHMIND_ISP,a.SIM_TV,a.COAL,a.EACADEMY,a.CHAKRESHWOR_SCHOOL,a.LITTLE_ANGEL,a.ESEWA_ROSY,a.JYOTISMATI_SCHOOL,a.ESEWA_PARIJAT,a.ESEWA_NORTH,a.ESEWA_JAINDRA];return!_.includes(c,b)}}}]),c.module("esewaPaymentApp").factory("PropertyOrderFactory",[function(){function a(a,b,d){for(var e=a,f={},g=0;g<=b.length-1;g++)f[b[g]]=e[b[g]],delete e[b[g]];c.forEach(e,function(a,b){f[b]=a});for(var h=d.length-1;h>=0;h--){var i=d[h],j=f[i];delete f[i],j&&(f[i]=j)}return c.forEach(f,function(a,b){a?f[b]=a:delete f[b]}),f}return{orderProperties:function(b,c,d){return a(b,c,d)},createTable:function(a){var b=[],c=[],d=_.groupBy(a,"DUE_BILL_OF");for(var e in d){var f=d[e];for(var g in f){var h=f[g];if(0===b.length)for(var i in h)b.push(i)}}for(var j in d){var k=d[j];for(var l in k){var m=k[l],n=[];for(var o in m)n.push(m[o]);c.push(n)}}return{header:b,body:c}},orderOccupation:function(a){var b=c.copy(a);return _.remove(b,function(a){return"Other"===a.occupation_name}),c.forEach(a,function(a){"Other"===a.occupation_name&&b.push(a)}),b}}}]),c.module("esewaPaymentApp").filter("hotelTextFilter",function(){return function(a){if(c.isDefined(a))return a=a.replace("<b>Facilities</b>",""),a=a.replace("<strong>Facilities</strong>",""),a.replace("<strong>What's Nearby</strong><ul></ul>","")}}),c.module("esewaPaymentApp").controller("BalanceRewardCtrl",["$scope","$rootScope","BalanceService","RewardService","AUTH_EVENTS","$timeout",function(a,b,c,d,e,f){b.userBalance={balance:"0"},b.UserRewardPoint={reward_point:"0"},b.$on(e.getBalanceAndRewards,function(){b.isAuthenticated()&&(c.getBalance().then(function(a){a?f(function(){b.$$phase||b.$apply(function(){b.userBalance={balance:a.balance,lastTransactionDate:a.last_transaction_date}})},500):b.$$phase||b.$apply(function(){b.userBalance={balance:"N/A"}})},function(){b.$$phase||b.$apply(function(){b.userBalance={balance:"N/A"}})}),d.getRewardPoints().then(function(a){f(function(){b.$$phase||b.$apply(function(){a?b.UserRewardPoint=a.plain():b.UserRewardPoint={reward_point:"N/A"}})},500)},function(){b.$$phase||b.$apply(function(){b.UserRewardPoint={reward_point:"N/A"}})}))})}]),c.module("esewaPaymentApp").controller("DateRangeController",["$scope",function(a){a.today=new Date;var b=function(a){a.preventDefault(),a.stopPropagation()};a.openToDate=function(c){b(c),a.toDateOpened=!0,a.fromDateOpened=!1},a.openFromDate=function(c){b(c),a.fromDateOpened=!0,a.toDateOpened=!1}}]),c.module("esewaPaymentApp").controller("PdfDownloadController",["$http","$scope","$window",function(a,b,d){new Date;b.getPdf=function(e,f,g,h){a({url:"api/web/auth/transactions/"+e+"/pdf?module_id="+f,method:"GET",responseType:"text",data:"",headers:{"Content-type":"text/plain",Accept:"text/plain,",transaction_version:h}}).success(function(a){a&&d.open(a,"_blank")}).error(function(a){c.isDefined(a)?b.responseMessage=a.data:b.responseMessage="Error occurred while generating excel."})}}]),c.module("esewaPaymentApp").controller("StatementController",["$scope","$filter","$compile","$window","$state","StatementService","$timeout","$http","StatementScrollService","FileSaverFactory","$rootScope","InformationService","ecmsg","INFORMATION","$sce","$modal",function(a,b,d,e,f,g,h,i,j,k,l,m,n,o,p,q){function r(){this.fromDate=new Date,this.fromDate.setDate(this.fromDate.getDate()-5),this.toDate=new Date,c.isDefined(l.userBalance)&&(c.isDefined(l.userBalance.lastTransactionDate)&&null!==l.userBalance.lastTransactionDate?(this.toDate=l.userBalance.lastTransactionDate,this.fromDate=l.userBalance.lastTransactionDate-432e6):(this.fromDate=new Date,this.fromDate.setDate(this.fromDate.getDate()-5),this.toDate=new Date))}function s(a){var b=new Date(a),c=""+(b.getMonth()+1),d=""+b.getDate(),e=b.getFullYear();return c.length<2&&(c="0"+c),d.length<2&&(d="0"+d),[e,c,d].join("-")}a.advanceSearch=!1,a.userId="",a.paginationOffset=1,a.product_id=1,a.dataAvailable=!1,a.showloadingBar=!1,l.clearMessage();var t=(new Date,new Date("2017-10-13")),u=new Date("2017-10-14");a.statusList=["PENDING","COMPLETE","CANCELED","TIMEOUT"],a.channelList=[{name:"WEB",value:"WEB_USER"},{name:"SMS",value:"MSEWA"},{name:"GPRS",value:"GPRS"}],a.TxnTypeList=["DR","CR"],a.minFromDate="2009-09-09",a.todayDate=new Date,a.maxToDate=a.todayDate,a.params={status:"ALL",channel:"ALL",txnType:"ALL",prop_value:""},a.searched=!1,a.searchTxn=function(){a.searched=!0,a.reloadTable()},a.isAdvanceSearchChanged=function(){return!("ALL"===a.params.txnType&&"ALL"===a.params.channel&&"ALL"===a.params.status)},a.reloadTable=function(){a.params.channel||(a.params.channel="ALL"),a.params.status||(a.params.status="ALL"),a.params.txnType||(a.params.txnType="ALL"),a.params.prop_value||(a.params.prop_value=""),a.userStatements=new j(s(a.dateRange.fromDate),s(a.dateRange.toDate),a.product_id,a.params.channel,a.params.status,a.params.txnType,a.params.prop_value),a.userStatements.nextPage()},a.$watch("dateRange.fromDate",function(b,d){b<t&&(a.statementMessage="Please select date earlier from 13 October 2017 for older statement or later from 13 October 2017 for new statement",a.maxToDate=t,a.dateRange.toDate=t,a.dateRange.toDate=t,c.isDefined(l.userBalance)&&c.isDefined(l.userBalance.lastTransactionDate)&&null!==l.userBalance.lastTransactionDate&&l.userBalance.lastTransactionDate<15079185e5&&(a.dateRange.fromDate=15074865e5)),b>t&&(a.minToDate=u,a.maxToDate=a.todayDate,a.statementMessage="Please select date earlier from 13 October 2017 for older statement or later from 13 October 2017 for new statement",a.dateRange.toDate=a.todayDate,c.isDefined(l.userBalance)&&(c.isDefined(l.userBalance.lastTransactionDate)&&null!==l.userBalance.lastTransactionDate&&(a.dateRange.toDate=l.userBalance.lastTransactionDate),c.isDefined(l.userBalance.lastTransactionDate)&&null!==l.userBalance.lastTransactionDate&&(a.dateRange.toDate=l.userBalance.lastTransactionDate))),a.trustedHtmlMessage=p.trustAsHtml(a.statementMessage)}),a.$watch("userBalance",function(b,c){a.resetTable()}),a.verifyDate=function(){a.dateRange.fromDate<t&&(a.statementMessage="Due to system upgrade we cannot provide all the statement at a time, Please select TO DATE lower than 13th October, 2017. For your statement before 13th October, 2017",a.maxToDate=t),a.trustedHtmlMessage=p.trustAsHtml(a.statementMessage)},a.resetTable=function(){a.dateRange=new r,a.userStatements=new j(s(a.dateRange.fromDate),s(a.dateRange.toDate),a.product_id,"ALL","ALL","ALL",""),a.userStatements.nextPage(),a.params={status:"ALL",channel:"ALL",txnType:"ALL",prop_value:""}},a.dateRange=new r,a.userStatements=new j(s(a.dateRange.fromDate),s(a.dateRange.toDate),0,"ALL","ALL","ALL"),a.getExcel=function(){a.showloadingBar=!0,i({url:"/api/web/auth/transactions/excel",params:{status:a.params.status,channel:a.params.channel,from_date:s(a.dateRange.fromDate),to_date:s(a.dateRange.toDate),product_id:0,type:a.params.txnType,module_id:a.params.module_id,prop_value:a.params.prop_value},method:"GET",responseType:"text",headers:{"Content-type":"text/plain",Accept:"text/plain,"}}).success(function(a){e.open(a.split("redirect:")[1],"_blank")}).error(function(b){if(c.isDefined(b)){var d=String.fromCharCode.apply(null,new Uint8Array(b)),e=JSON.parse(d),f=e.message;n.error(f)}else a.responseMessage="Error occurred while generating excel."})["finally"](function(){a.showloadingBar=!1})},a.showStatementDetail=function(a,b){f.go("user.statements.detail",{txnId:a,moduleId:b})},a.showAdvanceSearch=function(){a.params={status:"ALL",channel:"ALL",txnType:"ALL",prop_value:""},a.advanceSearch=!a.advanceSearch};o.userStatement;l.showInformation=!1,a.showStatement=function(a){q.open({templateUrl:"/user/merchant/statements/views/transaction_details.html",size:"lg",controller:"StatementDetailPopupController",resolve:{txnCode:function(){return a.transaction_code},moduleId:function(){return a.module_id},transaction_version:function(){return a.transaction_version}}})},a.getClassByStatus=function(a){switch(a){case"PENDING":return"warning";case"TIMEOUT":return"danger";case"CANCELED":return"danger";default:return""}}}]),c.module("esewaPaymentApp").controller("StatementDetailPopupController",["$rootScope","$scope","$modalInstance","StatementService","txnCode","AirlinePassengerDetailService","moduleId","transaction_version",function(a,b,d,e,f,g,h,i){function j(){return["external_reference_id","currency_symbol","status","nea_detail","subisuResponseMessage","callbackUrl","date1","date2","classId","packageCode","packageId","noOfDays","resultCode","resultDescription","tokenId","response_code","response_message","request_id"]}b.transactionId=f,b.moduleId=h,b.transaction_version=i,a.currentModal=d,b.cancel=function(){a.currentModal.dismiss()},b.doesNotMatch=function(a){return!_.includes(j(),a)},e.getTxnDetails(f,h,i).then(function(a){b.transactionDetails=a.plain(),b.transactionDetails.properties.outboundFlightNumber&&(b.ticketDetails=b.transactionDetails,b.passengerDto=g.getAirlinePassengerDetail(b.ticketDetails.properties),c.isDefined(b.ticketDetails.properties.inboundFlightNumber)&&(b.returnPassengerDto=g.getAirlineReturnPassengerDetail(b.ticketDetails.properties)),b.ticketDetails.transaction_code=b.transactionId,b.mobileNumber=b.ticketDetails.properties.buyerPhoneNumber,b.email=b.ticketDetails.properties.buyerEmail)},function(b){c.isDefined(b)?a.message=b.data.error_message:a.message="Error while fetching data."})}]),c.module("esewaPaymentApp").controller("TransactionDetailController",["$scope","StatementService","$stateParams","$http","$rootScope","NewTransactionDetail","AirlinePassengerDetailService",function(a,b,d,e,f,g,h){function i(){return["external_reference_id","currency_symbol","status","nea_detail","subisuResponseMessage","callbackUrl","date1","date2","classId","packageCode","packageId","noOfDays","resultCode","resultDescription","tokenId","planCategoryId","response_code","response_message","request_id"]}a.transactionDetails=g,a.transactionId=d.txnId,a.moduleId=d.moduleId,a.doesNotMatch=function(a){return!_.includes(i(),a)},a.transactionDetails.requestUniqueId||b.getTxnDetails(a.transactionId,a.moduleId).then(function(b){a.transactionDetails=b.plain(),a.transactionDetails.properties.outboundFlightNumber&&(a.ticketDetails=a.transactionDetails,a.passengerDto=h.getAirlinePassengerDetail(a.ticketDetails.properties),a.ticketDetails.transaction_code=a.transactionId,a.mobileNumber=a.ticketDetails.properties.buyerPhoneNumber,a.email=a.ticketDetails.properties.buyerEmail)},function(a){c.isDefined(a)?f.message=a.data.error_message:f.message="Error while fetching data."})}]),c.module("esewaPaymentApp").service("BalanceService",["Restangular",function(a){var b=a.all("auth");this.getBalance=function(){return b.one("balance").get()}}]),c.module("esewaPaymentApp").service("DateService",function(){this.getFormattedDate=function(a){var b=new Date(a.fromDate);b.setHours(0,0,0,0);var c=new Date(a.toDate);return c.setHours(23,59,59,999),{fromDate:b.toISOString(),toDate:c.toISOString()}},this.getFormattedToDate=function(a){var b=new Date(a.toDate);return b.setHours(23,59,59,999),{toDate:b.toISOString()}},this.getFormattedFromDate=function(a){var b=new Date(a.fromDate);return b.setHours(0,0,0,0),{fromDate:b.toISOString()}},this.getFormattedDummyDate=function(){var a={fromDate:new Date(0),toDate:new Date};return this.getFormattedDate(a)}}),c.module("esewaPaymentApp").factory("NewTransactionDetail",function(){var a,b,c,d,e,f,g,h,i,j;return{amount:a,properties:b,narration:c,requestUniqueId:d,channel:e,transaction_status:f,created:g,product_logo_url:h,product_name:i,processed_by:j,isDefined:function(){return a&&b&&g}}}),c.module("esewaPaymentApp").service("PaginationService",function(){this.getDefaultPagination=function(){return{page:0,size:15}},this.getPagination=function(a,b){return{page:a,size:b}}}),c.module("esewaPaymentApp").service("RewardService",["Restangular",function(a){var b=a.all("auth");this.getRewardPoints=function(){return b.one("reward_point").get()}}]),c.module("esewaPaymentApp").factory("StatementParams",[function(){var a,b,c,d,e,f;return{from_date:a,to_date:b,channel:c,status:d,size:e,page:f}}]),c.module("esewaPaymentApp").service("StatementScrollService",["Restangular","PaginationService",function(a,b){var c=function(a,b,c,d,e,f,g){this.statements=[],this.busy=!1,this.complete=!1,this.pageNumber=1,this.pageSize=15,this.emptyResult=!1,this.fromDate=a,this.toDate=b,this.product_id=c,this.channel=d,this.status=e,this.txnType=f,this.prop_value=g,this.nextPage()};return c.prototype.nextPage=function(){function c(a,b,c,d,e,f,g){return _.merge({from_date:a},{to_date:b},{product_id:c},{channel:d},{status:e},{type:f},{prop_value:g})}if(!this.busy&&!this.complete){this.busy=!0;var d=this,e=b.getPagination(d.pageNumber-1,d.pageSize),f=c(this.fromDate,this.toDate,this.product_id,this.channel,this.status,this.txnType,this.prop_value),g=_.merge(f,e),h=null;return h=a.all("auth").all("transactions").getList(g),h.then(function(a){d.busy=!1,a.length<d.pageSize&&(d.complete=!0,0===a.length&&1===d.pageNumber&&(d.emptyResult=!0)),a.length>0&&(d.statements=d.statements.concat(a)),d.pageNumber=d.pageNumber+1}),h}},c}]),c.module("esewaPaymentApp").service("StatementService",["Restangular",function(a){function b(a,b,c,d,e,f){return _.merge({from_date:a},{to_date:b},{channel:c},{status:d})}var c=a.all("auth");this.getStatements=function(a){return c.one("transactions").get(a)},this.getStatementDetails=function(a,b){return c.one(b+"").one("statement").customGET(a)},this.getExcel=function(a,d,e,f){return c.one("transactions/excel").get(b(a,d,e,f))},this.getTxnDetails=function(a,b,d){return c.one("transactions").one(a+"").get({module_id:b,transaction_version:d?d:"V3"})}}]),c.module("esewaPaymentApp").controller("KhanepaniController",["$state","$scope","$rootScope","StateConstant","$timeout","$location","$http",function(a,b,c,d,e,f,g){g.get("https://cdn.esewa.com.np/ui/data/khanepani.data.json").success(function(a){b.khanepaniList=a}),c.getDetails=function(b,e,g){c.isAuthenticated()?"AGGREGATE"===g.menuType?f.path(g.aggregateUrl):a.go(d.MAKE_PAYMENT,{product_code:b,product_name:e},{reload:!0}):c.openLoginDialog(b)},b.showSearch=function(a){b.showSearchflag=a}}])}(window.jQuery,window,window.angular);